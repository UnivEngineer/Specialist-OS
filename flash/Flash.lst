0001   0000             ;----------------------------------------------------------------------------
0002   0000             ; MXOS
0003   0000             ; FLASH.COM - драйвер флеш-диска на AT29C040A
0004   0000             ;
0005   0000             ; Драйвер имеет три функции (номер передаётся в регистре Е):
0006   0000             ; 1 - записать кластер (256 байт, номер кластера в регистре D, адрес буфера в HL);
0007   0000             ; 2 - считать  кластер (256 байт, номер кластера в регистре D, адрес буфера в HL);
0008   0000             ; 3 - выдать размер диска (в кластерах, в регистре А).
0009   0000             ;
0010   0000             ; Поддерживается флеш-память AT29C040A
0011   0000             ;
0012   0000             ; 2022-01-25 Разработано SpaceEngineer
0013   0000             ;
0014   0000             ;----------------------------------------------------------------------------
0015   0000             
0016   0000             ; Функции системы
0017   0000             fileGetSetDrive	= 0C842h	; Получить/установить активное устройство
0018   0000             installDriver   = 0C860h	; Установить драйвер накопителя
0019   0000             
0020   0000             ; Переменные системы
0021   0000             v_flashPage     = 8FF9h     ; Текущая страница флеш-диска (макс. 1Fh = 31)
0022   0000             
0023   0000             ; Порты ВВ55 #2
0024   0000             IO_PROG_A    = 0FFE4h
0025   0000             IO_PROG_B    = 0FFE5h
0026   0000             IO_PROG_C    = 0FFE6h
0027   0000             IO_PROG_MODE = 0FFE7h
0028   0000             
0029   0000             ; Команды для дрыгания ножками ВВ55
0030   0000             LATCH_0 = 0Ah   ; пин защёлки ИР22 = 0
0031   0000             LATCH_1 = 0Bh   ; пин защёлки ИР22 = 1
0032   0000             WRITE_0 = 0Ch   ; пин записи = 0
0033   0000             WRITE_1 = 0Dh   ; пин записи = 1
0034   0000             READ_0  = 0Eh   ; пин чтения = 0
0035   0000             READ_1  = 0Fh   ; пин чтения = 1
0036   0000             
0037   0000             ; Маски управляющих пинов ВВ55
0038   0000             MASK_STANDBY  = 0C0h    ; пин защёлки ИР22 = 0, пин записи = 1, пин чтения = 1
0039   0000             MASK_READ     = 040h    ; пин защёлки ИР22 = 0, пин записи = 1, пин чтения = 0
0040   0000             
0041   0000             ; Накопитель
0042   0000             DRIVE = 7 ; "H"
0043   0000             
0044   0000             ; Схема флеш-диска:
0045   0000             ; Порт A - данные
0046   0000             ; Порт B - адрес [A0-A7] или [A8-A15]
0047   0000             ; Порт C0...C4 - адрес [A17-A20]
0048   0000             ; Порт С5 - строб защёлки адреса [A8-A15] в ИР22 (лог. 1)
0049   0000             ; Порт С6 - строб записи в ПЗУ  (лог. 0)
0050   0000             ; Порт С7 - строб чтения из ПЗУ (лог. 0)
0051   0000             
0052   0000             ;----------------------------------------------------------------------------
0053   0000             
0054   FA00             .ORG 0FA00H
0055   FA00             
0056   FA00                 ; Установить драйвер для накопителя 7 ("H")
0057   FA00 3E 07       	MVI  A, DRIVE
0058   FA02 21 0F FA    	LXI  H, Driver
0059   FA05 C3 60 C8    	JMP	 installDriver
0060   FA08             
0061   FA08                 ; Установить накопитель 7 ("H")
0062   FA08 1E 01       	MVI	 E, 1 ; функция 1 - установить накопитель
0063   FA0A 3E 07       	MVI	 A, DRIVE
0064   FA0C C3 42 C8    	JMP	 fileGetSetDrive
0065   FA0F             
0066   FA0F             Driver:
0067   FA0F E5          	PUSH H
0068   FA10 D5          	PUSH D
0069   FA11 C5          	PUSH B
0070   FA12             
0071   FA12 7B              MOV	 A, E   ; номер функции
0072   FA13 FE 01       	CPI	 1
0073   FA15 CA 51 FA        JZ   FuncWrite
0074   FA18 FE 02       	CPI	 2
0075   FA1A CA 2D FA        JZ   FuncRead
0076   FA1D FE 03       	CPI	 3
0077   FA1F CA B8 FA    	JZ	 FuncGetSize
0078   FA22             
0079   FA22             Exit:
0080   FA22 F5              PUSH PSW
0081   FA23 3E C0           MVI  A, MASK_STANDBY    ; пин защёлки ИР22 = 0, пин записи = 1, пин чтения = 1
0082   FA25 32 E6 FF    	STA	 IO_PROG_C
0083   FA28 F1          	POP  PSW
0084   FA29 C1          	POP  B
0085   FA2A D1          	POP  D
0086   FA2B E1          	POP  H
0087   FA2C C9          	RET
0088   FA2D             
0089   FA2D             ;----------------------------------------------------------------------------
0090   FA2D             ; Чтение кластера
0091   FA2D             ; вход:
0092   FA2D             ; D  - номер кластера
0093   FA2D             ; HL - адрес буфера в памяти
0094   FA2D             
0095   FA2D             FuncRead:
0096   FA2D                 ; Настройка портов ВВ55
0097   FA2D 3E 90       	MVI	A, 90H          ; порт A - ввод, порты B и C - вывод 
0098   FA2F 32 E7 FF    	STA	IO_PROG_MODE
0099   FA32             
0100   FA32                 ; Запись номера 64к страницы и управляющих битов в порт C
0101   FA32 3A F9 8F        LDA v_flashPage     ; номер 64к страницы, макс 1Fh
0102   FA35 E6 1F           ANI 01FH            ; на всякий случай
0103   FA37 F6 40           ORI MASK_READ       ; пин защёлки ИР22 = 0, пин записи = 1, пин чтения = 0
0104   FA39 32 E6 FF    	STA	IO_PROG_C       ; записываем номер 64к страницы и управляющие биты
0105   FA3C             
0106   FA3C CD BC FA        CALL LatchHiAddr    ; записвываем старший байт адреса (номер кластера) в ИР22
0107   FA3F AF          	XRA  A
0108   FA40 5F          	MOV  E, A           ; начинаем с 0 адреса кластера
0109   FA41             
0110   FA41             ReadLoop:
0111   FA41 7B              MOV  A, E
0112   FA42 32 E5 FF        STA  IO_PROG_B      ; порт B = младший байт адреса в странице
0113   FA45 3A E4 FF    	LDA  IO_PROG_A      ; читаем байт из порта A
0114   FA48 77          	MOV	 M, A           ; сохраняем в память
0115   FA49 23          	INX	 H
0116   FA4A 1C          	INR	 E
0117   FA4B C2 41 FA    	JNZ  ReadLoop
0118   FA4E C3 22 FA    	JMP  Exit
0119   FA51             
0120   FA51             ;----------------------------------------------------------------------------
0121   FA51             ; Запись кластера
0122   FA51             ; вход:
0123   FA51             ; D  - номер кластера
0124   FA51             ; HL - адрес буфера в памяти
0125   FA51             
0126   FA51             FuncWrite:
0127   FA51                 ; Настройка портов ВВ55
0128   FA51 3E 80       	MVI	A, 80H          ; порты A, B и C - вывод 
0129   FA53 32 E7 FF    	STA	IO_PROG_MODE
0130   FA56             
0131   FA56                 ; Определяем номер чипа на флеш-диске
0132   FA56 3A F9 8F        LDA v_flashPage     ; номер 64к страницы, макс 1Fh
0133   FA59 E6 18           ANI 18h             ; обнуляем все биты кроме 3-го и 4-го
0134   FA5B 47              MOV B, A            ; в B получаем номер чипа * 8 (0, 8, 16, 24)
0135   FA5C             
0136   FA5C                 ; Отключение программной защиты от записи
0137   FA5C CD 9D FA        CALL DisableWriteProtection
0138   FA5F             
0139   FA5F                 ; Запись номера 64к страницы и управляющих битов в порт C
0140   FA5F 3A F9 8F        LDA v_flashPage     ; номер 64к страницы, макс 1Fh
0141   FA62 E6 1F           ANI 01FH            ; на всякий случай
0142   FA64 F6 C0           ORI MASK_STANDBY    ; пин защёлки ИР22 = 0, пин записи = 1, пин чтения = 1
0143   FA66 32 E6 FF    	STA	IO_PROG_C       ; записываем номер 64к страницы и управляющие биты
0144   FA69             
0145   FA69 CD BC FA        CALL LatchHiAddr    ; записвываем старший байт адреса (номер кластера) в ИР22
0146   FA6C AF          	XRA  A
0147   FA6D 5F          	MOV  E, A           ; начинаем с начала кластера (E = 0)
0148   FA6E             
0149   FA6E             WriteLoop:
0150   FA6E 7B              MOV  A, E
0151   FA6F 32 E5 FF        STA  IO_PROG_B      ; порт B = младший байт адреса в странице
0152   FA72 7E          	MOV	 A, M           ; читаем байт из памяти
0153   FA73 32 E4 FF    	STA  IO_PROG_A      ; записываем в порт A
0154   FA76 3E 0C           MVI  A, WRITE_0
0155   FA78 32 E7 FF        STA  IO_PROG_MODE   ; устанавливаем пин записи (C6 = 0)
0156   FA7B 3E 0D           MVI  A, WRITE_1
0157   FA7D 32 E7 FF        STA  IO_PROG_MODE   ; снимаем пин записи (C6 = 1)
0158   FA80 23          	INX	 H
0159   FA81 1C          	INR	 E
0160   FA82 C2 6E FA    	JNZ  WriteLoop
0161   FA85             
0162   FA85                 ; Ожидание окончания внутреннего цикла программирования флеш-памяти
0163   FA85 2B              DCX  H              ; последний адрес в буфере
0164   FA86 4E              MOV  C, M           ; читаем в C последний записанный байт из буфера
0165   FA87 1D              DCR  E              ; последний байт в кластере
0166   FA88             
0167   FA88                 ; Настройка портов ВВ55
0168   FA88 3E 90           MVI  A, 90h        ; порт A - ввод, порты B и C - вывод 
0169   FA8A 32 E7 FF        STA  IO_PROG_MODE
0170   FA8D             
0171   FA8D                 ; Максимум итераций цикла ожидания: надо 20 мс, 
0172   FA8D                 ; 1 цикл = 197 тактов = 98.5 мкс,
0173   FA8D                 ; 20 мс = 203 итераций
0174   FA8D 2E CC           MVI  L, 204
0175   FA8F             
0176   FA8F                 ; Цикл ожидания
0177   FA8F             Wait:
0178   FA8F 2D              DCR  L
0179   FA90 CA 22 FA        JZ   Exit
0180   FA93             
0181   FA93 CD CB FA        CALL ReadByteFromChip   ; читаем последний записанный байт из флеш памяти
0182   FA96             
0183   FA96                 ; пока программирование не окончено, флеш память будет выдавать
0184   FA96                 ; бит 7 последнего записанного байта в инверсном виде
0185   FA96 B9              CMP  C
0186   FA97 C2 8F FA        JNZ  Wait
0187   FA9A             
0188   FA9A C3 22 FA        JMP  Exit
0189   FA9D             
0190   FA9D             ;    ; Задержка 840 циклов по 24 тактов = 10 мс
0191   FA9D             ;    lxi h, 840
0192   FA9D             ;Delay:
0193   FA9D             ;    dcx	h       ; 5 тактов
0194   FA9D             ;    mov	a, h    ; 5 тактов
0195   FA9D             ;    ora	l       ; 4 такта
0196   FA9D             ;    jnz	Delay   ; 10 тактов
0197   FA9D             ;    jmp Exit
0198   FA9D             
0199   FA9D             ;----------------------------------------------------------------------------
0200   FA9D             ; Отключение программной защиты от записи
0201   FA9D             ; вход:
0202   FA9D             ;  B - номер чипа * 8 (0, 8, 16, 24)
0203   FA9D             
0204   FA9D             DisableWriteProtection:
0205   FA9D                 ; Управляющие коды пишутся в нулевую 64к страницу чипа,
0206   FA9D                 ; поэтому номер страницы менять не надо
0207   FA9D D5              push d
0208   FA9E                 ; Записываем байт AAh по адресу 05555h в чип флеш-памяти
0209   FA9E 3E AA           mvi  a, 0AAh
0210   FAA0 11 55 55        lxi  d, 5555h
0211   FAA3 CD DC FA        call WriteByteToChip
0212   FAA6                 ; Записываем байт 55h по адресу 02AAAh в чип флеш-памяти
0213   FAA6 3E 55           mvi  a, 55h
0214   FAA8 11 AA 2A        lxi  d, 2AAAh
0215   FAAB CD DC FA        call WriteByteToChip
0216   FAAE                 ; Записываем байт A0h по адресу 05555h в чип флеш-памяти
0217   FAAE 3E A0           mvi  a, 0A0h
0218   FAB0 11 55 55        lxi  d, 5555h
0219   FAB3 CD DC FA        call WriteByteToChip
0220   FAB6 D1              pop  d
0221   FAB7 C9              ret
0222   FAB8             
0223   FAB8             ;-----------------------------------------------------------------------------------
0224   FAB8             ; Определение объема накопителя
0225   FAB8             ; выход:
0226   FAB8             ;  A - количество кластеров
0227   FAB8             
0228   FAB8             FuncGetSize:
0229   FAB8 AF              XRA  A  ; Размер страниы флеш диска всегда 256 (= 0) кластеров
0230   FAB9 C3 22 FA        JMP  Exit
0231   FABC             
0232   FABC             ;    XRA	A
0233   FABC             ;    MOV	B, A ; счётчик занятых кластеров
0234   FABC             ;    MOV	D, A ; читаем кластер 0 (FAT)
0235   FABC             ;    MVI	E, 4 ; начиная с 4 байта
0236   FABC             ;    CALL LatchHiAddr
0237   FABC             ;Rep:
0238   FABC             ;    MOV  A, E
0239   FABC             ;    STA  IO_PROG_B    ; порт B = младший байт адреса в странице
0240   FABC             ;    LDA  IO_PROG_A    ; читаем байт из порта A
0241   FABC             ;    CPI  0FFH
0242   FABC             ;    JZ   SectorIsFree
0243   FABC             ;    INR  B    ; увеличить счетчик занятых кластеров
0244   FABC             ;SectorIsFree:
0245   FABC             ;    INR  E    ; следующий байт в кластере FAT
0246   FABC             ;    JNZ  Rep  ; E обнулится при переходе через 0FFh
0247   FABC             ;    JMP  Exit
0248   FABC             
0249   FABC             ;----------------------------------------------------------------------------
0250   FABC             ; Защёлкивание старшего байта адреса в ИР22 флеш-диска
0251   FABC             ; вход:
0252   FABC             ;   D - старший байт адреса (номер кластера)
0253   FABC             
0254   FABC             LatchHiAddr:
0255   FABC 3E 0B           MVI A, LATCH_1
0256   FABE 32 E7 FF        STA IO_PROG_MODE  ; поднимаем защёлку ИР22 (C5 = 1)
0257   FAC1 7A              MOV A, D
0258   FAC2 32 E5 FF        STA IO_PROG_B     ; порт B = старший байт адреса (номер кластера)
0259   FAC5 3E 0A           MVI A, LATCH_0
0260   FAC7 32 E7 FF        STA IO_PROG_MODE  ; опускаем защёлку ИР22 (C5 = 0), защёлкивая старший байт адреса
0261   FACA C9              RET
0262   FACB             
0263   FACB             ;----------------------------------------------------------------------------
0264   FACB             ; Чтеие байта из чипа флеш памяти
0265   FACB             ; вход:
0266   FACB             ;   DE - адрес в 64к странице
0267   FACB             ;   B - номер 64к страницы
0268   FACB             ; выход:
0269   FACB             ;   A - байт данных
0270   FACB             ;   пин чтения остаётся активным (C7 = 0)
0271   FACB             
0272   FACB             ReadByteFromChip:
0273   FACB CD BC FA        CALL LatchHiAddr    ; записвываем старший байт адреса (номер кластера) в ИР22
0274   FACE 7B              MOV  A, E
0275   FACF 32 E5 FF        STA  IO_PROG_B      ; порт B = младший байт адреса
0276   FAD2 78              MOV  A, B
0277   FAD3 F6 40           ORI  MASK_READ      ; пин защёлки ИР22 = 0, пин записи = 1, пин чтения = 0
0278   FAD5 32 E6 FF    	STA  IO_PROG_C      ; записываем номер 64к страницы и управляющие биты
0279   FAD8 3A E4 FF        LDA  IO_PROG_A      ; читаем байт из порта A
0280   FADB C9              RET
0281   FADC             
0282   FADC             ;----------------------------------------------------------------------------
0283   FADC             ; Запись байта в чип флеш памяти
0284   FADC             ; вход:
0285   FADC             ;   DE - адрес в 64к странице
0286   FADC             ;   B - номер 64к страницы
0287   FADC             ;   A - байт данных
0288   FADC             
0289   FADC             WriteByteToChip:
0290   FADC 32 E4 FF        STA  IO_PROG_A      ; порт A = байт данных
0291   FADF CD BC FA        CALL LatchHiAddr    ; записвываем старший байт адреса (номер кластера) в ИР22
0292   FAE2 7B              MOV  A, E
0293   FAE3 32 E5 FF        STA  IO_PROG_B      ; порт B = младший байт адреса
0294   FAE6 78              MOV  A, B
0295   FAE7 F6 C0           ORI  MASK_STANDBY   ; пин защёлки ИР22 = 0, пин записи = 1, пин чтения = 1
0296   FAE9 32 E6 FF    	STA  IO_PROG_C      ; записываем номер 64к страницы и управляющие биты
0297   FAEC 3E 0C           MVI  A, WRITE_0
0298   FAEE 32 E7 FF        STA  IO_PROG_MODE   ; устанавливаем пин записи (C6 = 0)
0299   FAF1 3E 0D           MVI  A, WRITE_1
0300   FAF3 32 E7 FF        STA  IO_PROG_MODE   ; снимаем пин записи (C6 = 1)
0301   FAF6 C9              RET
0302   FAF7             
0303   FAF7             ;----------------------------------------------------------------------------
0304   FAF7             
0305   FAF7 00          WaitFlag: .db 0     ; флаг ожидания завершения форматирования предыдущего сектора
0306   FAF8             
0307   FAF8             ;----------------------------------------------------------------------------
0308   FAF8             
0309   FAF8             .END
tasm: Number of errors = 0
