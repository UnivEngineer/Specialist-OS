   1  0000              ;----------------------------------------------------------------------------
   2  0000              ; MXOS
   3  0000              ; E.COM - текстовой редактор
   4  0000              ;
   5  0000              ; 2022-02-03 Дизассемблировано SpaceEngineer
   6  0000              ;----------------------------------------------------------------------------
   7  0000
   8  0000                  INCLUDE "../include/mxos.inc"
   1+ 0000              ;-----------------------------------------------------------------------
   2+ 0000              ; MXOS
   3+ 0000              ; Точки входа и настройки сборки MXOS
   4+ 0000              ;
   5+ 0000              ; Новая карта памяти:
   6+ 0000              ;   8FDF-8FFF - [  32 B] Переменные
   7+ 0000              ;   9000-BFFF - [12  KB] Экран
   8+ 0000              ;   C000-D3FF - [5120 B] DOS.SYS
   9+ 0000              ;   D400-DBFF - [2048 B] Свободно (2048 байт)
  10+ 0000              ;   DC00-EDFF - [ 512 B] Драйвер магнитофона
  11+ 0000              ;   DE00-DFFF - [ 512 B] Драйвер флеш-диска
  12+ 0000              ;   E000-E7FF - [2048 B] Шрифт
  13+ 0000              ;   E800-FAFF - [4864 B] Системные программы (NC.COM, E.COM, DL-RED.COM, FORMAT.COM, MON2.COM, ...)
  14+ 0000              ;   FB00-FEFF - [1024 B] Дисковый кэш (fat + каталог)
  15+ 0000              ;   FF00-FF81 - [ 130 B] Командная строка
  16+ 0000              ;   FF82-FFBF - [  62 B] Стек
  17+ 0000              ;   FFC0-FFEF - [  32 B] Непереключаемое ОЗУ, драйвер обмена с RAM диском
  18+ 0000              ;   FFE0-FFFF - [  32 B] Оборудование
  19+ 0000              ;
  20+ 0000              ; Старая карта памяти:
  21+ 0000              ;   8FDF-8FFF - [  32 B] Переменные
  22+ 0000              ;   9000-BFFF - [12  KB] Экран
  23+ 0000              ;   C000-CFFF - [4096 B] DOS.SYS
  24+ 0000              ;   D000-E1FF - [4607 B] Системные программы (NC.COM, E.COM, DL-RED.COM)
  25+ 0000              ;   E200-E5FF - [1024 B] Свободно (1024 байт)
  26+ 0000              ;   E600-E7FF - [ 512 B] Драйвер магнитофона
  27+ 0000              ;   E800-E8FF - [ 256 B] Свободно (256 байт)
  28+ 0000              ;   E900-F0FF - [2048 B] Шрифт (можно отключить запуском ROMFNT.COM или опцией LOAD_FONT=0)
  29+ 0000              ;   F100-F8FF - [2048 B] Системные программы (FORMAT.COM, MON2.COM, ...)
  30+ 0000              ;   F900-F9FF - [ 256 B] Свободно (256 байт)
  31+ 0000              ;   FA00-FAFF - [ 256 B] Драйвер флеш-диска
  32+ 0000              ;   FB00-FEFF - [1024 B] Дисковый буфер (fat + каталог)
  33+ 0000              ;   FF00-FF81 - [ 130 B] Командная строка
  34+ 0000              ;   FF82-FFBF - [  62 B] Стек
  35+ 0000              ;   FFC0-FFEF - [  32 B] Непереключаемое ОЗУ, драйвер обмена с RAM диском
  36+ 0000              ;   FFE0-FFFF - [  32 B] Оборудование
  37+ 0000              ;-----------------------------------------------------------------------
  38+ 0000
  39+ 0000
  40+ 0000              ;-----------------------------------------------------------------------
  41+ 0000              ; Конфигурация сборки
  42+ 0000              ;-----------------------------------------------------------------------
  43+ 0000
  44+ 0000              NEW_MEMORY_MAP       =  1       ; Новая карта памяти
  45+ 0000              RAMD_MAX_PAGE        =  16      ; Максимальное количество страниц RAM диска
  46+ 0000              RAMD_PAGE_END        =  0FFBBh  ; Включить поддержку ДОЗУ большего чем 64 Кб
  47+ 0000              ROM_64K              =  1       ; Включить поддержку ПЗУ 64 Кб Специалиста МХ2
  48+ 0000              ENABLE_COLOR         =  1       ; Включить поддержку цвета
  49+ 0000              EMBED_FONT           =  0       ; Встроить шрифт в программу (при запуске шрифт копируется на FONT_ADDR)
  50+ 0000              LOAD_FONT            =  1       ; Загружать шрифт в ОЗУ
  51+ 0000              COLOR_BIOS           =  0F0h    ; Цвет командной строки
  52+ 0000              RAMFOS_COMPATIBILITY =  1       ; Совместимость с RAMFOS (WIP)
  53+ 0000              BOOT_FROM_TAPE       =  0       ; Включить загрузку с ленты при нажатой клавише после сброса
  54+ 0000
  55+ 0000                  IF  NEW_MEMORY_MAP
  56+ 0000              FONT_ADDR = 0E000h  ; Адрес шрфита
  57+ 0000                  ELSE
  58+ 0000 ~            FONT_ADDR = 0E900h  ; Адрес шрфита
  59+ 0000                  ENDIF
  60+ 0000
  61+ 0000                  IF  LOAD_FONT
  62+ 0000              FONT_ADDR_DIV_8 = FONT_ADDR/8
  63+ 0000                  ELSE
  64+ 0000 ~            FONT_ADDR_DIV_8 = -1
  65+ 0000                  ENDIF
  66+ 0000
  67+ 0000              ;-----------------------------------------------------------------------
  68+ 0000              ; Переменные ОС в подэкранном пространстве и их начальные значения
  69+ 0000              ; Доступ к переменным и программ польователя:
  70+ 0000              ; ld a, bios_vars.lastKey
  71+ 0000              ;-----------------------------------------------------------------------
  72+ 0000
  73+ 0000                  STRUCT BIOS_VARIABLES
  74+ 0000 ~            _reserv_1     DW      -1              ; 8FDFh -
  75+ 0000 ~            tapeError     DW      0C800h          ; 8FE1h - Адрес, куда происходит переход при ошибке чтения с ленты
  76+ 0000 ~            tapeAddr      DW      -1              ; 8FE3h - Адрес программы загруженной с ленты
  77+ 0000 ~            _reserv_2     DW      -1              ; 8FE5h -
  78+ 0000 ~            charGen       DW      FONT_ADDR_DIV_8 ; 8FE7h - Адрес альтернативного знакогенератора / 8
  79+ 0000 ~            cursorCfg     DB       21h ; 0A9h     ; 8FE9h - Внешний вид курсора (биты: 7 - мигание (если 0), 654 - положение (Y) от низа строки, 3210 - размер по высоте)
  80+ 0000 ~            koi7          DB       0   ; 0FFh     ; 8FEAh - 0FFh = включен KOI-7, 0 = включен KOI-8
  81+ 0000 ~            escMode       DB      -1              ; 8FEBh - Обработка ESC-последовательности
  82+ 0000 ~            keyLocks      DB      0BAh ; 3Ah      ; 8FECh - Caps Lock или Рус/Lat (3A - прописные анг, BA - строчные анг, BB - прописные рус, 3B - строчные рус)
  83+ 0000 ~            _reserv_3     DW      -1              ; 8FEDh -
  84+ 0000 ~            lastLastKey   DB      -1              ; 8FEFh - Предпоследняя нажатая клавиша
  85+ 0000 ~            lastKey       DB      -1              ; 8FF0h - Последняя нажатая клавиша
  86+ 0000 ~            beepFreq      DB       5Fh            ; 8FF1h - Частота звукового сигнала (также влияет на длительность)
  87+ 0000 ~            beepDuration  DB       20h            ; 8FF2h - Длительность звукового сигнала (сколько раз повторять посылку)
  88+ 0000 ~            tapeInverse   DB      0FFh            ; 8FF3h - Признак инверсии данных с ленты
  89+ 0000 ~            cursorDelay   DB       20h            ; 8FF4h - Задержка мигания курсора
  90+ 0000 ~            antiBsDelay   DB      0E0h            ; 8FF5h - Задержка защиты от дребезга контактов клавиш
  91+ 0000 ~            oldSP         DW      -1              ; 8FF6h - Используется для сохранения SP некоторыми функциями
  92+ 0000 ~            ramPageCount  DB      RAMD_MAX_PAGE   ; 8FF8h - Количество детектированных 64кб страниц RAM-диска
  93+ 0000 ~            _reserv_4     DB       0              ; 8FF9h -
  94+ 0000 ~            inverse       DW       0              ; 8FFAh - Инвертирование текста (0=нормальный текст, 0FFFFh=инверсный)
  95+ 0000 ~            cursorY       DB      -1              ; 8FFCh - Положение курсора по вертикали в пикселях
  96+ 0000 ~            cursorX       DB      -1              ; 8FFDh - Положение курсора по горизонтали в пикселях / 2
  97+ 0000 ~            writeDelay    DB      28h             ; 8FFEh - Скорость при записи на ленту
  98+ 0000 ~            readDelay     DB      3Ch             ; 8FFFh - Скорость при чтении с ленты
  99+ 0000                  ENDS
 100+ 0000
 101+ 0000              ; Блок переменных BIOS начинается с адреса 8FDFh
 102+ 0000              bios_vars   BIOS_VARIABLES = 8FDFh
 103+ 0000
 104+ 0000              ;-----------------------------------------------------------------------
 105+ 0000              ; Стандартные точки входа ОС
 106+ 0000              ; Отмеченные [OLD] применять не рекомендуется
 107+ 0000              ; Отмеченные [MXOS2] - новые в MXOS 2
 108+ 0000              ;-----------------------------------------------------------------------
 109+ 0000
 110+ 0000              bios_init               = 0C000h ; Теплая перезагрузка
 111+ 0000
 112+ 0000              ; Устаревшие точки, лечше не применять
 113+ 0000              bios_keyScanOld         = 0C003h ; [OLD] Получить код нажатой клавиши, = bios_keyScan
 114+ 0000              bios_drawCursorOld      = 0C006h ; [OLD] Нарисовать/стереть курсор
 115+ 0000              bios_clearScreenOld     = 0C010h ; [OLD] Оистка экрана
 116+ 0000              bios_printCharOld       = 0C037h ; [OLD] Вывод символа на экран
 117+ 0000              bios_beep_Old           = 0C170h ; [OLD] Звуковой сигнал
 118+ 0000              bios_delay_l            = 0C18Fh ; [OLD] Задержка l циклов
 119+ 0000              bios_delay_b            = 0C190h ; [OLD] Задержка b циклов
 120+ 0000              bios_getchOld           = 0C337h ; [OLD] Ожидание ввода с клавиатуры
 121+ 0000              bios_tapeReadOld        = 0C377h ; [OLD] Чтение байта с магнитофона
 122+ 0000              bios_tapeWriteOld       = 0C3D0h ; [OLD] Запись байта на магнитофон
 123+ 0000              bios_cmp_hl_de          = 0C427h ; [OLD] Сравнить hl и de
 124+ 0000              bios_memcpy_bc_hl       = 0C42Dh ; [OLD] Скопировать блок памяти
 125+ 0000              bios_printStringOld     = 0C438h ; [OLD] Вывод строки на экран
 126+ 0000
 127+ 0000              ; Стандартные точки C800h
 128+ 0000              bios_reboot             = 0C800h ; Запустить NC.COM
 129+ 0000              bios_getch              = 0C803h ; Ожидание ввода с клавиатуры
 130+ 0000              bios_tapeRead           = 0C806h ; Чтение байта с магнитофона
 131+ 0000              bios_printChar          = 0C809h ; Вывод символа на экран
 132+ 0000              bios_tapeWrite          = 0C80Ch ; Запись байта на магнитофон
 133+ 0000              bios_input              = 0C80Fh ; Ввод строки с клавиатуры
 134+ 0000              bios_keyCheck           = 0C812h ; Получить код нажатой клавиши, = bios_keyScan
 135+ 0000              bios_printHexByte       = 0C815h ; Вывод HEX числа на экран (байт)
 136+ 0000              bios_printString        = 0C818h ; Вывод строки на экран
 137+ 0000              bios_keyScan            = 0C81Bh ; Получить код нажатой клавиши
 138+ 0000              bios_getCursorPos       = 0C81Eh ; Получить координаты курсора в hl (координаты в пикселях)
 139+ 0000              bios_setCursorPos       = 0C821h ; Установить координаты курсора из hl (координаты в пикселях)
 140+ 0000              bios_tapeLoad           = 0C824h ; Загрузить программу с магнитофона
 141+ 0000              bios_tapeSave           = 0C827h ; Сохранить программу на магнитофон
 142+ 0000              bios_calcCS             = 0C82Ah ; Расчет контрольной суммы
 143+ 0000              bios_printHexWord       = 0C82Dh ; Вывод HEX числа на экран (слово)
 144+ 0000              bios_getMemTop          = 0C830h ; Получить объем доступной памяти
 145+ 0000              bios_setMemTop          = 0C833h ; Установить объем доступной памяти
 146+ 0000              bios_printer            = 0C836h ; Напечатать байт на принтере
 147+ 0000                  IF RAMFOS_COMPATIBILITY
 148+ 0000              bios_strToHex           = 0C839h ; [MXOS2] Преобразвоние строки в HEX формате в число
 149+ 0000                  ELSE
 150+ 0000 ~            bios_rebootAlt          = 0C839h ; Запустить NC.COM
 151+ 0000                  ENDIF
 152+ 0000              bios_rebootAlt2         = 0C83Ch ; Запустить NC.COM
 153+ 0000              bios_fileList           = 0C83Fh ; Получить список файлов
 154+ 0000              bios_fileGetSetDrive    = 0C842h ; Получить/установить активное устройство
 155+ 0000              bios_fileCreate         = 0C845h ; Создать файл
 156+ 0000              bios_fileLoad           = 0C848h ; Загрузить файл по адресу из заголовка этого файла
 157+ 0000              bios_fileDelete         = 0C84Bh ; Удалить файл
 158+ 0000              bios_fileRename         = 0C84Eh ; Переименовать файл
 159+ 0000              bios_fileLoadInfo       = 0C851h ; Загрузить информацию о файле
 160+ 0000              bios_fileGetSetAddr     = 0C854h ; Получить/установить адрес загрузки файла
 161+ 0000              bios_fileGetSetAttr     = 0C857h ; Получить/установить атрибуты файла
 162+ 0000              bios_fileNamePrepare    = 0C85Ah ; Преобразовать имя файла во внутренний формат
 163+ 0000              bios_fileExec           = 0C85Dh ; Запустить файл
 164+ 0000              bios_installDriver      = 0C860h ; Установить драйвер накопителя
 165+ 0000              bios_diskDriver         = 0C863h ; Драйвер выбранного диска
 166+ 0000              bios_fileLoad2          = 0C866h ; Загрузить файл по адресу de
 167+ 0000
 168+ 0000              ; Новые точки C800h MXOS2
 169+ 0000              bios_printCharReal      = 0C869h ; [MXOS2] Вывод символа на экран (только реальные символы)
 170+ 0000              bios_printDecWord       = 0C86Ch ; [MXOS2] Вывод числа экран в десятичной форме
 171+ 0000              bios_setRAMDDriver      = 0C86Fh ; [MXOS2] Установить драйвр рам-диска
 172+ 0000              bios_getDriveFreeSpace  = 0C872h ; [MXOS2] Получить оставшийся свободный объем диска
 173+ 0000              bios_upperCase          = 0C875h ; [MXOS2] Перевод кода символа КОИ-8 в верхний регистр
 174+ 0000              bios_strcmp             = 0C878h ; [MXOS2] Сравнение строк, чувствительное к регистру
 175+ 0000              bios_stricmp            = 0C87Bh ; [MXOS2] Сравнение строк, нечувствительное к регистру
 176+ 0000              bios_sub_hl_de          = 0C87Eh ; [MXOS2] Вычитание hl и de: hl = hl - de
 177+ 0000              bios_div_hl_2           = 0C881h ; [MXOS2] Деление hl на 2: hl = hl / 2
 178+ 0000              bios_mul_hl_de          = 0C884h ; [MXOS2] Умножение hl на de: hl = hl * de
 179+ 0000              bios_div_hl_de          = 0C887h ; [MXOS2] Деление hl на de: hl = hl / de, de = hl % de
 180+ 0000
 181+ 0000              ;-----------------------------------------------------------------------
 182+ 0000              ; Адрес таблицы переходов драйвера магнитофона
 183+ 0000              ;-----------------------------------------------------------------------
 184+ 0000
 185+ 0000              TAPE_DRIVER_JUMPS = bios_tapeReadOld    ; размещается на месте бывшей п/п чтения байта
 186+ 0000
 187+ 0000              ;-----------------------------------------------------------------------
 188+ 0000              ; Непереключаемое ОЗУ ПК "Специалист-MX" (0FFC0h-0FFDF, 32 байта)
 189+ 0000              ;-----------------------------------------------------------------------
 190+ 0000
 191+ 0000              bios_RAMDRead   = 0FFC0h ; п/п чтения из ДОЗУ
 192+ 0000              bios_RAMDWrite  = 0FFD0h ; п/п записи в  ДОЗУ
 193+ 0000
 194+ 0000              ;-----------------------------------------------------------------------
 195+ 0000              ; Порты устройств ПК "Специалист-MX2" (0FFE0h-0FFFF, 32 байта)
 196+ 0000              ;-----------------------------------------------------------------------
 197+ 0000
 198+ 0000              IO_KEYB_A       =  0FFE0h   ; ВВ55 клавиатуры
 199+ 0000              IO_KEYB_B       =  0FFE1h
 200+ 0000              IO_KEYB_C       =  0FFE2h
 201+ 0000              IO_KEYB_MODE    =  0FFE3h
 202+ 0000              IO_PROG_A       =  0FFE4h   ; ВВ55 программатора/флеш диска
 203+ 0000              IO_PROG_B       =  0FFE5h
 204+ 0000              IO_PROG_C       =  0FFE6h
 205+ 0000              IO_PROG_MODE    =  0FFE7h
 206+ 0000              IO_FDD_CMD      =  0FFE8h   ; контроллер дисковода ВГ93
 207+ 0000              IO_FDD_TRACK    =  0FFE9h
 208+ 0000              IO_FDD_SECTOR   =  0FFEAh
 209+ 0000              IO_FDD_DATA     =  0FFEBh
 210+ 0000              IO_TIMER_CH0    =  0FFECh   ; таймер ВИ53
 211+ 0000              IO_TIMER_CH1    =  0FFEDh
 212+ 0000              IO_TIMER_CH2    =  0FFEEh
 213+ 0000              IO_TIMER_MODE   =  0FFEFh
 214+ 0000              IO_FDD_REQ      =  0FFF0h   ; контроллер дисковода
 215+ 0000              IO_FDD_MOTOR    =  0FFF1h
 216+ 0000              IO_FDD_SIDE     =  0FFF2h
 217+ 0000              IO_FDD_DRIVE    =  0FFF3h
 218+ 0000              IO_COLOR        =  0FFF8h   ; регистр цвета
 219+ 0000              IO_PAGE_RAM     =  0FFFCh   ; порт включения основного ОЗУ
 220+ 0000              IO_PAGE_RAMD    =  0FFFDh   ; порт включения ОЗУ RAM-дисков
 221+ 0000              IO_PAGE_ROM     =  0FFFEh   ; порт включения ПЗУ
 222+ 0000              IO_PAGE_STD     =  0FFFFh   ; порт включения STD режима
 223+ 0000
 224+ 0000              ;-----------------------------------------------------------------------
 225+ 0000              ; Структура файловой системы
 226+ 0000              ;-----------------------------------------------------------------------
 227+ 0000
 228+ 0000              ; Структура каталога
 229+ 0000              DIR_DESCR_SIZE  = 32    ; размер дескриптора файла в каталоге (байт)
 230+ 0000              DIR_NAME_LENGTH = 8     ; длина имени файла  (байт)
 231+ 0000              FAT_ITEM_SIZE   = 2     ; размер записи в таблице FAT (байт)
 232+ 0000
 233+ 0000              SECTOR_SIZE  = 00100h   ; размер сектора 256 байт
 234+ 0000              CLUSTER_SIZE = 00100h   ; размер кластера 256 байт
 235+ 0000
 236+ 0000              ; Специальные коды кластеров FAT
 237+ 0000              FAT12_BAD = 00FF7h  ; плохой кластер
 238+ 0000              FAT16_BAD = 0FFF7h
 239+ 0000              FAT12_EOC = 00FFFh  ; последний кластер файла
 240+ 0000              FAT16_EOC = 0FFFFh
 241+ 0000              FAT12_RES = 00FFFh  ; зарезервированный кластер
 242+ 0000              FAT16_RES = 0FFFFh
 243+ 0000
 244+ 0000              ;-----------------------------------------------------------------------
 245+ 0000              ; Десткриптор файла (одна запись в каталоге) FAT12/16/32
 246+ 0000              ;-----------------------------------------------------------------------
 247+ 0000
 248+ 0000                  STRUCT FILE_DESCRIPTOR  ; 32 байта
 249+ 0000 ~            name            BLOCK   DIR_NAME_LENGTH     ; смещение 00h, 8 байт  - имя файла
 250+ 0000 ~            ext             BLOCK   3                   ; смещение 08h, 3 байта - расширение имени файла
 251+ 0000 ~            attrib          BLOCK   1                   ; смещение 0Bh, 1 байт  - атрибуты файла
 252+ 0000 ~            ntReserved      BLOCK   1                   ; смещение 0Ch, 1 байт  - используются в Windows NT
 253+ 0000 ~            createTimeTenth BLOCK   1                   ; смещение 0Dh, 1 байт  - (только FAT32) время создания файла, десятки миллисекунд (0-199)
 254+ 0000 ~            createTime      BLOCK   2                   ; смещение 0Eh, 2 байта - (только FAT32) время создания файла, секунды*2 (0-43200)
 255+ 0000 ~            createDate      BLOCK   2                   ; смещение 10h, 2 байта - (только FAT32) дата  создания файла
 256+ 0000 ~            loadAddress     BLOCK   2  ; accDate        ; смещение 12h, 2 байта - начальный адрес загрузки в ОЗУ, он же и стартовый (!!! временный костыль, в FAT32 это accDate - дата доступа к файлу !!!)
 257+ 0000 ~            firstClusterHi  BLOCK   2                   ; смещение 14h, 2 байта - номер первого кластера в FAT, старшее слово
 258+ 0000 ~            writeTime       BLOCK   2                   ; смещение 16h, 2 байта - время модификации файла, секунды*2 (0-43200)
 259+ 0000 ~            writeDate       BLOCK   2                   ; смещение 18h, 2 байта - дата  модификации файла
 260+ 0000 ~            firstCluster    BLOCK   2                   ; смещение 1Ah, 2 байта - номер первого кластера в FAT, младшее слово
 261+ 0000 ~            size            BLOCK   4                   ; смещение 1Ch, 4 байта - размер файла в байтах
 262+ 0000                  ENDS
 263+ 0000
 264+ 0000              ;-----------------------------------------------------------------------
 265+ 0000              ; Информация о активном накопителе (диске)
 266+ 0000              ;-----------------------------------------------------------------------
 267+ 0000
 268+ 0000                  STRUCT DISK_INFO
 269+ 0000 ~            sectorSize          BLOCK   2   ; размер сектора, байт (256, 512, 1024)
 270+ 0000 ~            sectorsPerCluster   BLOCK   2   ; размер кластера, секторов (1, 2, 4, 8)
 271+ 0000 ~            resSectors          BLOCK   2   ; сколько секторов занимает зарезервированная область = первый сектор таблицы fat
 272+ 0000 ~            fatSectors          BLOCK   2   ; сколько секторов занимает таблица fat
 273+ 0000 ~            dirSectors          BLOCK   2   ; сколько секторов занимает корневой каталог
 274+ 0000 ~            totalSectors        BLOCK   2   ; сколько всего секторов на диске
 275+ 0000 ~            rootDirMaxFiles     BLOCK   2   ; максимум файлов в корневом каталоге
 276+ 0000 ~            descrPerSector      BLOCK   2   ; сколько дескрипторов файлов вмещается в один сектор
 277+ 0000 ~            fatNumCells         BLOCK   2   ; количество ячеек в таблице fat (= fatSectors * sectorSize / 2)
 278+ 0000 ~            dirStartSector      BLOCK   2   ; первый сектор корневого каталога
 279+ 0000 ~            dataStartSector     BLOCK   2   ; первый сектор области данных
 280+ 0000 ~            volumeLabel         BLOCK  12   ; метка тома и 0 в конце
 281+ 0000 ~            isValid             BLOCK   1   ; 0 = нет драйвера, 1 = диск не распознан, 2 = диск распознан, корректно отформатирован
 282+ 0000                  ENDS
 283+ 0000
 284+ 0000              DISK_NO_DRIVER = 0
 285+ 0000              DISK_INVALID   = 1
 286+ 0000              DISK_VALID     = 2
 287+ 0000
 288+ 0000              ;-----------------------------------------------------------------------
 289+ 0000              ; Буферы в памяти
 290+ 0000              ;-----------------------------------------------------------------------
 291+ 0000
 292+ 0000              ; Дисковый кэш
 293+ 0000              FAT_CACHE_ADDR = 0FB00h ; адрес кэша секторов fat в памяти
 294+ 0000              FAT_CACHE_SIZE = 1024   ; размер кэша в байтах
 295+ 0000              FAT_CACHE_CAPACITY = FAT_CACHE_SIZE / SECTOR_SIZE   ; сколько секторов вмещается в кэш
 296+ 0000
 297+ 0000              ; Буфер для загрузки BAT файла
 298+ 0000                  IF NEW_MEMORY_MAP
 299+ 0000              BAT_BUFFER = 0E800h
 300+ 0000                  ELSE
 301+ 0000 ~            BAT_BUFFER = 0FC00h
 302+ 0000                  ENDIF
 303+ 0000
 304+ 0000              ; Командная строка и стек
 305+ 0000              CMD_LINE   = 0FF00h  ; 192 байта, но в конце стек
 306+ 0000              STACK_ADDR = 0FFC0h  ; стек
 307+ 0000
 308+ 0000              ;-----------------------------------------------------------------------
 309+ 0000              ; Всякие полезности
 310+ 0000              ;-----------------------------------------------------------------------
 311+ 0000
 312+ 0000              ; Макрос для заполнения памяти от текущего адреса до указанного
 313+ 0000                  MACRO ORG_PAD adr
 314+ 0000 ~                     IF $ > adr
 315+ 0000 ~                       ; вывод сообщения об ошибке
 316+ 0000 ~                       ASSERT 0
 317+ 0000 ~                       DISPLAY /l, "Error! ORG_PAD failed! ", $, " is more than ", adr
 318+ 0000 ~                     ELSE
 319+ 0000 ~                       ; заполнение памяти
 320+ 0000 ~                       BLOCK adr-$, 0FFh
 321+ 0000 ~                     ENDIF
 322+ 0000 ~                     ORG adr
 323+ 0000                  ENDM
 324+ 0000
 325+ 0000                  MACRO ORG_PAD0 adr
 326+ 0000 ~                     IF $ > adr
 327+ 0000 ~                       ; вывод сообщения об ошибке
 328+ 0000 ~                       ASSERT 0
 329+ 0000 ~                       DISPLAY /l, "Error! ORG_PAD0 failed! ", $, " is more than ", adr
 330+ 0000 ~                     ELSE
 331+ 0000 ~                       ; заполнение памяти
 332+ 0000 ~                       BLOCK adr-$, 0
 333+ 0000 ~                     ENDIF
 334+ 0000 ~                     ORG adr
 335+ 0000                  ENDM
 336+ 0000
 337+ 0000              ; Макросы для проверки текущего адреса
 338+ 0000                  MACRO ASSERT_EQUAL adr
 339+ 0000 ~                     IF $ != adr
 340+ 0000 ~                       ASSERT 0
 341+ 0000 ~                       DISPLAY /l, "Error! Entry point has been shifted (", $, " != ", adr, ")"
 342+ 0000 ~                     ENDIF
 343+ 0000                  ENDM
 344+ 0000
 345+ 0000                  MACRO ASSERT_DONT_FIT adr
 346+ 0000 ~                     IF $ > adr
 347+ 0000 ~                       ASSERT 0
 348+ 0000 ~                       DISPLAY /l, "Error! Image did not fit (", $, " > ", adr, ")"
 349+ 0000 ~                     ENDIF
 350+ 0000                  ENDM
 351+ 0000
 352+ 0000              ;-----------------------------------------------------------------------
 353+ 0000              ; Конец
 354+ 0000              ;-----------------------------------------------------------------------
 355+ 0000
   9  0000
  10  0000              ; Компиляция оригинального редаткора (если 1)
  11  0000              STANDARD_EDITOR = 0
  12  0000
  13  0000              ; Используемые подпрограммы DOS.SYS:
  14  0000              ; bios_beep_Old         = 0C170h
  15  0000              ; bios_delay_b          = 0C190h
  16  0000              ; bios_cmp_hl_de        = 0C427h
  17  0000              ; bios_memcpy_bc_hl     = 0C42Dh
  18  0000              ; bios_reboot           = 0C800h
  19  0000              ; bios_getch            = 0C803h
  20  0000              ; bios_tapeRead         = 0C806h
  21  0000              ; bios_printChar        = 0C809h
  22  0000              ; bios_tapeWrite        = 0C80Ch
  23  0000              ; bios_printString      = 0C818h
  24  0000              ; bios_calcCS           = 0C82Ah
  25  0000              ; bios_fileCreate       = 0C845h
  26  0000              ; bios_fileLoadInfo     = 0C851h
  27  0000              ; bios_fileNamePrepare  = 0C85Ah
  28  0000              ; bios_fileLoad2        = 0C866h
  29  0000
  30  0000              ; Используемые переменные DOS.SYS:
  31  0000              ; bios_vars.lastKey     = 08FF0h
  32  0000              ; bios_vars.tapeInverse = 08FF3h
  33  0000              ; bios_vars.cursorDelay = 08FF4h
  34  0000              ; bios_vars.inverse     = 08FFAh
  35  0000              ; bios_vars.cursorY     = 08FFCh
  36  0000
  37  0000              ; Используемые порты устройств:
  38  0000              ; IO_KEYB_A = 0FFE0h
  39  0000              ; IO_KEYB_B = 0FFE1h
  40  0000
  41  0000              ;----------------------------------------------------------------------------
  42  0000
  43  0000              ; Цвета
  44  0000
  45  0000              COLOR_TEXT      = 0B1h
  46  0000              COLOR_STATUSBAR = 071h
  47  0000
  48  0000              ; Когда цвет включен, макрос вставляет такой код
  49  0000                  MACRO COLOR x
  50  0000 ~                    IF STANDARD_EDITOR==0
  51  0000 ~                        ld a, x
  52  0000 ~                        ld (IO_COLOR), a
  53  0000 ~                    ENDIF
  54  0000                  ENDM
  55  0000
  56  0000              ;----------------------------------------------------------------------------
  57  0000
  58  0000              ; Собственные переменные
  59  0000                  STRUCT EDITOR_VARIABLES
  60  0000 ~            buffer  BLOCK  10, 0
  61  0000 ~            last    BLOCK  1,  0
  62  0000                  ENDS
  63  0000
  64  0000              ; Блок переменных редактора начинается с адреса 8F80H
  65  0000              editor_vars EDITOR_VARIABLES = 8F80H
  66  0000
  67  0000              ;----------------------------------------------------------------------------
  68  0000
  69  0000              ; Начало программы
  70  0000                  IF NEW_MEMORY_MAP && !STANDARD_EDITOR
  71  0000                      ORG 0E800h
  72  0000                  ELSE
  73  0000 ~                    ORG 0D000h
  74  0000                  ENDIF
  75  E800
  76  E800              ;----------------------------------------------------------------------------
  77  E800
  78  E800              ; Буферы в конце программы
  79  E800              BUFFER1 = $ + 0F0Ah ; 0DF0AH
  80  E800              BUFFER2 = $ + 0F00h ; 0DF00H
  81  E800
  82  E800              ;----------------------------------------------------------------------------
  83  E800
  84  E800              SMC1:
  85  E800 C3 44 F6             JP    LBL145    ; адрес этого перехода изменяется п/п LBL3
  86  E803 C3 3E F2             JP    LBL103
  87  E806
  88  E806                      ; Что-то непонятное, границы буфера текста?
  89  E806 00           VAR01:  DB    0
  90  E807 18           VAR02:  DB    18h
  91  E808 00           VAR03:  DB    0
  92  E809 85           VAR04:  DB    85h
  93  E80A
  94  E80A 21 22 E8     LBL2:   LD    HL,REF2
  95  E80D CD 18 C8             CALL  bios_printString
  96  E810
  97  E810                      ; Похоже на обработчик ошибки ввода/вывода с ленты
  98  E810              LBL3:   ; ??? Считаем контрольную сумму блока 7000-8EFF
  99  E810 21 00 70             LD    HL,7000H
 100  E813 11 00 8F             LD    DE,8F00H
 101  E816 CD 2A C8             CALL  bios_calcCS
 102  E819                      ; Суровая самомодификация кода:
 103  E819                      ; Меняем адрес в первой инстукции JP в начале редактора на LBL4
 104  E819 21 D1 E8     SMC6:   LD    HL, LBL4
 105  E81C 22 01 E8             LD    (SMC1+1),HL
 106  E81F
 107  E81F                      ; И прыгаем на LBL4
 108  E81F C3 D1 E8             JP    LBL4
 109  E822
 110  E822 0A 20 20 20  REF2:   DB    0AH,"          EDITOR VERSION 4.1, (C) OM"
 110  E826 20 20 20 20
 110  E82A 20 20 20 45
 110  E82E 44 49 54 4F
 110  E832 52 20 56 45
 110  E836 52 53 49 4F
 110  E83A 4E 20 34 2E
 110  E83E 31 2C 20 28
 110  E842 43 29 20 4F
 110  E846 4D
 111  E847 53           REF3:   DB    "S"
 112  E848 4B           REF4:   DB    "K"
 113  E849 20           REF5:   DB    " "
 114  E84A 4B 53 4F 46  REF6:   DB    "KSOFT ",27H,"92",2EH,00H
 114  E84E 54 20 27 39
 114  E852 32 2E 00
 115  E855 00 00        VAR1:   DW    0000H
 116  E857 00 00        VAR2:   DW    0000H
 117  E859 00 00        VAR3:   DW    0000H
 118  E85B 00           VAR4:   DB    00H
 119  E85C 00           VAR5:   DB    00H
 120  E85D 00 00        VAR6:   DW    0000H
 121  E85F 00 00        VAR7:   DW    0000H
 122  E861 00 00        VAR8:   DW    0000H
 123  E863 04 05 08     REF7:   DB    04H,05H,08H
 124  E866 00           VAR9:   DB    00H
 125  E867 1F 0A 20 20  REF8:   DB    1FH,0AH,"  OUT OF MEMORY",2EH,00H
 125  E86B 4F 55 54 20
 125  E86F 4F 46 20 4D
 125  E873 45 4D 4F 52
 125  E877 59 2E 00
 126  E87A 1F           REF9:   DB    1FH
 127  E87B 0A 20 46 49  REF10:  DB    0AH," FILE: ",00H
 127  E87F 4C 45 3A 20
 127  E883 00
 128  E884 08 20 08 00  REF11:  DB    08H,20H,08H,00H           ; <-, ' ', <-
 129  E888 0A 20 4D 49  REF12:  DB    0AH," MISTAKE",2EH,00H
 129  E88C 53 54 41 4B
 129  E890 45 2E 00
 130  E893 53 45 41 52  REF13:  DB    "SEARCH: "
 130  E897 43 48 3A 20
 131  E89B 00 41 4C 4C  REF14:  DB    00H,"ALL V33",00H,"RLN]N",00H,"y"
 131  E89F 20 56 33 33
 131  E8A3 00 52 4C 4E
 131  E8A7 5D 4E 00 79
 132  E8AB
 133  E8AB 1F 0A 20 4E  txtNew:     DB    1FH,0AH," NEW ?",00H
 133  E8AF 45 57 20 3F
 133  E8B3 00
 134  E8B4 49 4E 53 45  txtIns:     DB    "INSERT   ",00H
 134  E8B8 52 54 20 20
 134  E8BC 20 00
 135  E8BE 4F 56 45 52  txtOvr:     DB    "OVERWRITE",00H
 135  E8C2 57 52 49 54
 135  E8C6 45 00
 136  E8C8 4C 49 4E 45  txtLine:    DB    "LINE",00H
 136  E8CC 00
 137  E8CD 43 4F 4C 00  txtCol:     DB    "COL",00H
 138  E8D1
 139  E8D1              LBL4:   ; Читаем указатель стека в hl
 140  E8D1 21 00 00             LD    HL,0000H
 141  E8D4 39                   ADD   HL,SP
 142  E8D5                      ; И записываем его в код п/п SMC4
 143  E8D5 22 DC F3             LD    (SMC4+1),HL
 144  E8D8
 145  E8D8                      COLOR COLOR_TEXT
 145  E8D8             >        IF STANDARD_EDITOR==0
 145  E8D8 3E B1       >            ld a, COLOR_TEXT
 145  E8DA 32 F8 FF    >            ld (IO_COLOR), a
 145  E8DD             >        ENDIF
 146  E8DD
 147  E8DD 3E 10        LBL5:   LD    A,10H         ; 16
 148  E8DF 32 8A 8F             LD    (editor_vars.last),A
 149  E8E2 AF                   XOR   A
 150  E8E3 32 5B E8             LD    (VAR4),A
 151  E8E6 67                   LD    H,A
 152  E8E7 6F                   LD    L,A
 153  E8E8 22 5D E8             LD    (VAR6),HL
 154  E8EB 22 FA 8F             LD    (bios_vars.inverse),HL
 155  E8EE 21 01 00             LD    HL,0001H    ; 1
 156  E8F1 22 61 E8             LD    (VAR8),HL
 157  E8F4 2A 06 E8             LD    HL,(VAR01)
 158  E8F7 22 55 E8             LD    (VAR1),HL
 159  E8FA 22 59 E8             LD    (VAR3),HL
 160  E8FD 5D                   LD    E,L
 161  E8FE 54                   LD    D,H
 162  E8FF 7E           LBL6:   LD    A,(HL)
 163  E900 B7                   OR    A
 164  E901 C2 06 E9             JP    NZ,LBL7
 165  E904 3D                   DEC   A
 166  E905 77                   LD    (HL),A
 167  E906 3C           LBL7:   INC   A
 168  E907 CA 0E E9             JP    Z,LBL8
 169  E90A 23                   INC   HL
 170  E90B C3 FF E8             JP    LBL6
 171  E90E CD 09 F2     LBL8:   CALL  SUB38
 172  E911 C2 19 E9             JP    NZ,LBL9
 173  E914 36 0D                LD    (HL),0DH    ; 13
 174  E916 23                   INC   HL
 175  E917 36 FF                LD    (HL),0FFH   ; 255
 176  E919 22 57 E8     LBL9:   LD    (VAR2),HL
 177  E91C 0E 1F        LBL10:  LD    C,1FH         ; 31
 178  E91E CD 09 C8             CALL  bios_printChar
 179  E921 CD 18 EA             CALL  SUB1
 180  E924 21 24 E9     REF21:  LD    HL,REF21    ; 53535
 181  E927 E5                   PUSH  HL
 182  E928 2A FC 8F             LD    HL,(bios_vars.cursorY)
 183  E92B E5                   PUSH  HL
 184  E92C CD 68 F4             CALL  SUB56
 185  E92F 21 00 00             LD    HL,0000H
 186  E932 CD E7 EB             CALL  SUB14
 187  E935 EB                   EX    DE,HL
 188  E936 21 F9 8C             LD    HL,8CF9H    ; 36089
 189  E939 22 FC 8F             LD    (bios_vars.cursorY),HL
 190  E93C EB                   EX    DE,HL
 191  E93D 11 F6 FF             LD    DE,0FFF6H   ; 65526
 192  E940 06 20                LD    B,20H         ; 32 ' '
 193  E942 23                   INC   HL
 194  E943 CD 66 F3             CALL  SUB51
 195  E946 7D                   LD    A,L
 196  E947 C6 3A                ADD   A,3AH         ; 58 ':'
 197  E949 4F                   LD    C,A
 198  E94A CD 09 C8             CALL  bios_printChar
 199  E94D CD 71 F4             CALL  SUB57
 200  E950 E1                   POP   HL
 201  E951 22 FC 8F             LD    (bios_vars.cursorY),HL
 202  E954 C3 0B F6             JP    keyInput
 203  E957
 204  E957              ;----------------------------------------------------------------------
 205  E957
 206  E957                      ; Продолжение разбора кода нажатой клавиши
 207  E957              keyInput2:
 208  E957 4F                   LD    C,A               ; сохраняем в регистре c
 209  E958 FE 7F                CP    7FH               ; Del - удалить символ над курсором
 210  E95A CA F2 EB             JP    Z,keyHandler_Del
 211  E95D FE 07                CP    07H               ; F8 - отмена изменений в строке
 212  E95F CA DF F1             JP    Z,keyHandler_F8
 213  E962 FE 01                CP    01H               ; F2 - курсор на страницу вверх (PageUp)
 214  E964 CA 5D ED             JP    Z,keyHandler_F2
 215  E967 FE 02                CP    02H               ; F3 - курсор на страницу вниз (PageDn)
 216  E969 CA 82 ED             JP    Z,keyHandler_F3
 217  E96C FE 20                CP    20H               ; пробел
 218  E96E D2 8C EB             JP    NC,keyHandler_Space
 219  E971 B7                   OR    A                 ; F1 - Ins (перекл. режима Insert/Overwrite)
 220  E972 CA DB EB             JP    Z,keyHandler_F1
 221  E975
 222  E975                      ; Теперь проходм по таблице подпрограмм
 223  E975 21 88 E9             LD    HL, KeyHendlerTable
 224  E978              fkh_Loop:
 225  E978 7E                   LD    A,(HL)        ; код клавиши
 226  E979 B7                   OR    A             ; если 0 - достигнут конец таблицы
 227  E97A CA 16 F2             JP    Z,Beep4       ; бип 4 раза и выход
 228  E97D 23                   INC   HL
 229  E97E 5E                   LD    E,(HL)        ; de = адрес подпрограммы
 230  E97F 23                   INC   HL
 231  E980 56                   LD    D,(HL)
 232  E981 23                   INC   HL
 233  E982 B9                   CP    C             ; сравниваем a и запомненный в с код клавиши
 234  E983 C2 78 E9             JP    NZ,fkh_Loop   ; если не равно, повтор цикла
 235  E986 D5                   PUSH  DE            ; алрес п/п - в стек
 236  E987 C9                   RET                 ; переход на адрес п/п
 237  E988
 238  E988              ;----------------------------------------------------------------------
 239  E988
 240  E988                  STRUCT  KEY_HANDLER
 241  E988 ~            key:        DB  0
 242  E988 ~            address:    DW  0
 243  E988                  ENDS
 244  E988
 245  E988                      ; Таблица переходов на подпрограммы
 246  E988                      ; код символа, адрес
 247  E988              KeyHendlerTable:
 248  E988 1A 58 EA             KEY_HANDLER  1Ah, keyHandler_Down   ; Вниз      - курсор вниз
 249  E98B 19 82 EA             KEY_HANDLER  19h, keyHandler_Up     ; Вверх     - курсор вверх
 250  E98E 08 FD EA             KEY_HANDLER  08h, keyHandler_Left   ; Влево     - курсор влево
 251  E991 18 F2 EA             KEY_HANDLER  18h, keyHandler_Right  ; Вправо    - курсор вправо
 252  E994 0D 22 EB             KEY_HANDLER  0Dh, keyHandler_Enter  ; Enter     - вставить строку ниже (не разбивает текущую строку!)
 253  E997 09 05 ED             KEY_HANDLER  09h, keyHandler_Tab    ; Tab       - курсор на 4 (8) позиций влево, с привязкой по сетке (?)
 254  E99A 1F E5 E9             KEY_HANDLER  1Fh, keyHandler_CTP    ; СТР       - выход без сохранения!
 255  E99D 02 F8 E9             KEY_HANDLER  02h, keyHandler_F3_2   ; F3 снова?
 256  E9A0 06 7A F0             KEY_HANDLER  06h, keyHandler_F7     ; F7        - поиск текста в строке курсора и ниже (перематывает документ на строку с текстом)
 257  E9A3 0C 1D EB             KEY_HANDLER  0Ch, keyHandler_Home   ; Home      - курсор в начало строки
 258  E9A6 0A 0D EB             KEY_HANDLER  0Ah, keyHandler_End    ; End (ПС)  - курсор в конец строки
 259  E9A9 1B AD E9             KEY_HANDLER  1Bh, keyHandler_Esc    ; Esc       - режим Esc-последовательности
 260  E9AC 00                   DB  00H
 261  E9AD
 262  E9AD              ;----------------------------------------------------------------------
 263  E9AD
 264  E9AD                      ; Обработка нажатия Esc
 265  E9AD              keyHandler_Esc:
 266  E9AD CD 26 EC             CALL    SUB15
 267  E9B0
 268  E9B0                      ; Ожидаем ввод второго символа Esc-последовательности
 269  E9B0 CD 03 C8             CALL    bios_getch
 270  E9B3 4F                   LD      C,A
 271  E9B4
 272  E9B4                      ; Проходм по второй таблице подпрограмм
 273  E9B4 21 BA E9             LD      HL,KeyHendlerTable2
 274  E9B7 C3 78 E9             JP      fkh_Loop
 275  E9BA
 276  E9BA              ;----------------------------------------------------------------------
 277  E9BA
 278  E9BA                      ; Таблица переходов на подпрограммы
 279  E9BA                      ; код символа, адрес
 280  E9BA              KeyHendlerTable2:
 281  E9BA 0C 09 EA             KEY_HANDLER  0Ch, keyHandler_Esc_Home   ; Esc-Home - курсор в начало первой страницы
 282  E9BD 0A AD ED             KEY_HANDLER  0Ah, keyHandler_Esc_End    ; Esc-End  - курсор в начало последней страницы
 283  E9C0 4C C1 ED             KEY_HANDLER  4Ch, keyHandler_Esc_L      ; Esc-L    - выделить текущую строку, второй раз Esc-L - выделить от первой выделенной первой до текущей
 284  E9C3 44 F2 ED             KEY_HANDLER  44h, keyHandler_Esc_D      ; Esc-D    - удалить выделенные строки
 285  E9C6 55 66 EE             KEY_HANDLER  55h, keyHandler_Esc_U      ; Esc-U    - снять выделение строк
 286  E9C9 4F 8F EE             KEY_HANDLER  4Fh, keyHandler_Esc_O      ; Esc-O    - сохранить файл на магнитофон
 287  E9CC 49 1F EF             KEY_HANDLER  49h, keyHandler_Esc_I      ; Esc-I    - загрузить файл с магнитофона
 288  E9CF 56 0F F0             KEY_HANDLER  56h, keyHandler_Esc_V      ; Esc-V    - загрузить файл с магнитофона (в другом формате?)
 289  E9D2 47 14 F0             KEY_HANDLER  47h, keyHandler_Esc_G      ; Esc-G    - загрузить файл с магнитофона и вставить в конец документа
 290  E9D5 4E C3 F1             KEY_HANDLER  4Eh, keyHandler_Esc_N      ; Esc-N    - новый файл (очистить буфер)
 291  E9D8 4A E6 F0             KEY_HANDLER  4Ah, keyHandler_Esc_J      ; Esc-J    - объединить текущую строку и следующую
 292  E9DB 53 15 F1             KEY_HANDLER  53h, keyHandler_Esc_S      ; Esc-S    - разбить строку в положении курсора
 293  E9DE 43 4E F1             KEY_HANDLER  43h, keyHandler_Esc_C      ; Esc-C    - вставить выделенные строки ниже текущей
 294  E9E1 4D 81 F1             KEY_HANDLER  4Dh, keyHandler_Esc_M      ; Esc-M    - переместить выделенные строки ниже текущей
 295  E9E4 00                   DB  00H
 296  E9E5
 297  E9E5              ;----------------------------------------------------------------------
 298  E9E5
 299  E9E5              keyHandler_CTP:
 300  E9E5                      COLOR COLOR_BIOS
 300  E9E5             >        IF STANDARD_EDITOR==0
 300  E9E5 3E F0       >            ld a, COLOR_BIOS
 300  E9E7 32 F8 FF    >            ld (IO_COLOR), a
 300  E9EA             >        ENDIF
 301  E9EA 0E 1F                LD    C,1FH
 302  E9EC CD 09 C8             CALL  bios_printChar
 303  E9EF CD 26 EC             CALL  SUB15
 304  E9F2 CD DA F3             CALL  SUB54
 305  E9F5 C3 00 C8             JP    bios_reboot
 306  E9F8
 307  E9F8              keyHandler_F3_2:
 308  E9F8 CD 26 EC             CALL  SUB15
 309  E9FB                      COLOR COLOR_BIOS
 309  E9FB             >        IF STANDARD_EDITOR==0
 309  E9FB 3E F0       >            ld a, COLOR_BIOS
 309  E9FD 32 F8 FF    >            ld (IO_COLOR), a
 309  EA00             >        ENDIF
 310  EA00 0E 1F                LD    C,1FH
 311  EA02 CD 09 C8             CALL  bios_printChar
 312  EA05 CD DA F3             CALL  SUB54
 313  EA08 C9                   RET
 314  EA09
 315  EA09              keyHandler_Esc_Home:
 316  EA09 21 01 00             LD    HL,0001H    ; 1; [4]
 317  EA0C 22 61 E8             LD    (VAR8),HL
 318  EA0F 2A 06 E8             LD    HL,(VAR01)
 319  EA12 22 55 E8             LD    (VAR1),HL
 320  EA15 22 59 E8             LD    (VAR3),HL
 321  EA18 2A 55 E8     SUB1:   LD    HL,(VAR1)   ; [10]
 322  EA1B EB                   EX    DE,HL
 323  EA1C 2A 59 E8             LD    HL,(VAR3)
 324  EA1F CD 09 F2             CALL  SUB38
 325  EA22 CA 2B EA             JP    Z,SUB2
 326  EA25 CD 13 F3             CALL  SUB49
 327  EA28 C3 18 EA             JP    SUB1
 328  EA2B CD 3D F4     SUB2:   CALL  SUB55         ; [2]
 329  EA2E 01 0C 18     SUB3:   LD    BC,180CH    ; 6156; [2]
 330  EA31 CD 09 C8     LBL14:  CALL  bios_printChar
 331  EA34 CD A8 EA             CALL  SUB7
 332  EA37 3C                   INC   A
 333  EA38 CA 41 EA             JP    Z,SUB4
 334  EA3B 05                   DEC   B
 335  EA3C 0E 0A                LD    C,0AH         ; 10
 336  EA3E C2 31 EA             JP    NZ,LBL14
 337  EA41 CD 97 F3     SUB4:   CALL  SUB53         ; [2]
 338  EA44 0E 0C                LD    C,0CH         ; 12
 339  EA46 C3 09 C8             JP    bios_printChar
 340  EA49 CD 26 EC     LBL15:  CALL  SUB15         ; [3]
 341  EA4C CD 2C F2     SUB5:   CALL  SUB43         ; [5]
 342  EA4F 2A 55 E8             LD    HL,(VAR1)
 343  EA52 CD 2B EA             CALL  SUB2
 344  EA55 C3 35 F2             JP    SUB44
 345  EA58
 346  EA58              keyHandler_Down:
 347  EA58 CD 26 EC             CALL  SUB15
 348  EA5B CD FD F2             CALL  SUB48
 349  EA5E C8                   RET   Z
 350  EA5F CD 25 F3             CALL  SUB50
 351  EA62 3A FC 8F             LD    A,(bios_vars.cursorY)
 352  EA65 FE EE                CP    0EEH          ; 238
 353  EA67 C2 09 C8             JP    NZ,bios_printChar
 354  EA6A 2A 55 E8             LD    HL,(VAR1)
 355  EA6D CD 21 F2             CALL  SUB42
 356  EA70 22 55 E8             LD    (VAR1),HL
 357  EA73 CD 2C F2             CALL  SUB43
 358  EA76 CD 6E F2             CALL  SUB45
 359  EA79 2A 59 E8             LD    HL,(VAR3)
 360  EA7C CD A8 EA             CALL  SUB7
 361  EA7F C3 35 F2             JP    SUB44
 362  EA82
 363  EA82              keyHandler_Up
 364  EA82 CD 26 EC             CALL  SUB15
 365  EA85 CD 13 F3             CALL  SUB49
 366  EA88 C8                   RET   Z
 367  EA89 CD 25 F3             CALL  SUB50
 368  EA8C 3A FC 8F             LD    A,(bios_vars.cursorY)
 369  EA8F FE 08                CP    08H           ; 8
 370  EA91 C2 09 C8             JP    NZ,bios_printChar
 371  EA94 2A 59 E8             LD    HL,(VAR3)
 372  EA97 22 55 E8             LD    (VAR1),HL
 373  EA9A E5                   PUSH  HL
 374  EA9B CD 9D F2             CALL  SUB46
 375  EA9E E1                   POP   HL
 376  EA9F CD 2C F2             CALL  SUB43
 377  EAA2 CD A8 EA             CALL  SUB7
 378  EAA5 C3 35 F2             JP    SUB44
 379  EAA8 CD 1D EB     SUB7:   CALL  keyHandler_Home          ; [4]
 380  EAAB CD D6 EA             CALL  SUB8
 381  EAAE D2 B6 EA             JP    NC,LBL16
 382  EAB1 3E FF                LD    A,0FFH                ; 255
 383  EAB3 32 FA 8F             LD    (bios_vars.inverse),A
 384  EAB6 7E           LBL16:  LD    A,(HL)
 385  EAB7 FE 0D                CP    0DH           ; 13
 386  EAB9 0E 20                LD    C,20H         ; 32 ' '
 387  EABB CC 09 C8             CALL  Z,bios_printChar
 388  EABE 7E           LBL17:  LD    A,(HL)
 389  EABF 4F                   LD    C,A
 390  EAC0 3C                   INC   A
 391  EAC1 CA CD EA             JP    Z,LBL18
 392  EAC4 23                   INC   HL
 393  EAC5 CD 09 C8             CALL  bios_printChar
 394  EAC8 FE 0E                CP    0EH           ; 14
 395  EACA C2 BE EA             JP    NZ,LBL17
 396  EACD AF           LBL18:  XOR   A
 397  EACE 32 FA 8F             LD    (bios_vars.inverse),A
 398  EAD1 32 FB 8F             LD    (bios_vars.inverse+1),A
 399  EAD4 79                   LD    A,C
 400  EAD5 C9                   RET
 401  EAD6 D5           SUB8: PUSH  DE            ; [7]
 402  EAD7 EB                   EX    DE,HL
 403  EAD8 2A 5D E8             LD    HL,(VAR6)
 404  EADB 7C                   LD    A,H
 405  EADC B5                   OR    L
 406  EADD CA EF EA             JP    Z,LBL19
 407  EAE0 2B                   DEC   HL
 408  EAE1 CD 09 F2             CALL  SUB38
 409  EAE4 D2 EF EA             JP    NC,LBL19
 410  EAE7 2A 5F E8             LD    HL,(VAR7)
 411  EAEA 2B                   DEC   HL
 412  EAEB CD 09 F2             CALL  SUB38
 413  EAEE 3F                   CCF
 414  EAEF EB           LBL19:  EX    DE,HL         ; [2]
 415  EAF0 D1                   POP   DE
 416  EAF1 C9                   RET
 417  EAF2
 418  EAF2              keyHandler_Right:
 419  EAF2 CD F8 F1             CALL  SUB36
 420  EAF5 CA DF F3             JP    Z,LBL117
 421  EAF8 06 BA        LBL20:  LD    B,0BAH                ; 186
 422  EAFA C3 05 EB             JP    LBL21
 423  EAFD
 424  EAFD              keyHandler_Left:
 425  EAFD CD F8 F1             CALL  SUB36
 426  EB00 CA 0C F4             JP    Z,LBL120
 427  EB03 06 00                LD    B,00H
 428  EB05 3A FD 8F     LBL21:  LD    A,(bios_vars.cursorY+1)
 429  EB08 B8                   CP    B
 430  EB09 C8                   RET   Z
 431  EB0A C3 09 C8             JP    bios_printChar
 432  EB0D
 433  EB0D              keyHandler_End:
 434  EB0D CD 60 EB             CALL  SUB12
 435  EB10 CD 54 EB             CALL  SUB10
 436  EB13 21 0A E8             LD    HL,LBL2             ; 53258
 437  EB16 CD 0F F2             CALL  SUB39
 438  EB19 7B                   LD    A,E
 439  EB1A C3 22 ED             JP    LBL48
 440  EB1D
 441  EB1D              keyHandler_Home:
 442  EB1D AF                   XOR   A             ; [4]
 443  EB1E 32 FD 8F             LD    (bios_vars.cursorY+1),A
 444  EB21 C9                   RET
 445  EB22
 446  EB22              keyHandler_Enter:
 447  EB22 2A 59 E8             LD    HL,(VAR3)
 448  EB25 CD D6 EA             CALL  SUB8
 449  EB28 DA 16 F2             JP    C,Beep4
 450  EB2B CD 60 EB             CALL  SUB12
 451  EB2E CD 54 EB             CALL  SUB10
 452  EB31 3E 0D                LD    A,0DH         ; 13
 453  EB33 12                   LD    (DE),A
 454  EB34 CD 26 EC             CALL  SUB15
 455  EB37 CD 1D EB             CALL  keyHandler_Home
 456  EB3A 2A 59 E8             LD    HL,(VAR3)
 457  EB3D 0E 18                LD    C,18H         ; 24
 458  EB3F 7E           LBL23:  LD    A,(HL)
 459  EB40 FE 20                CP    20H           ; 32 ' '
 460  EB42 C2 4C EB             JP    NZ,LBL24
 461  EB45 CD 09 C8             CALL  bios_printChar
 462  EB48 23                   INC   HL
 463  EB49 C3 3F EB             JP    LBL23
 464  EB4C 0E 1A        LBL24:  LD    C,1AH         ; 26
 465  EB4E CD 58 EA             CALL  keyHandler_Down
 466  EB51 C3 9D F2             JP    SUB46
 467  EB54
 468  EB54                      ; В REF6 изначально текст "KSOFT '92"
 469  EB54 11 4A E8     SUB10:  LD    DE, REF6
 470  EB57
 471  EB57                      ; Пропус пробелов в строке по адресу de
 472  EB57              SkipSpaces:
 473  EB57 1B                   DEC   DE
 474  EB58 1A                   LD    A,(DE)
 475  EB59 FE 20                CP    20H
 476  EB5B CA 57 EB             JP    Z,SkipSpaces
 477  EB5E 13                   INC   DE
 478  EB5F C9                   RET
 479  EB60
 480  EB60 3A 5B E8     SUB12:  LD    A,(VAR4)    ; [7]
 481  EB63 B7                   OR    A
 482  EB64 C0                   RET   NZ
 483  EB65 2F                   cpl
 484  EB66 32 5B E8             LD    (VAR4),A
 485  EB69 21 0A E8             LD    HL,LBL2             ; 53258
 486  EB6C 3E 40                LD    A,40H         ; 64 '@'
 487  EB6E 36 20        LBL25:  LD    (HL),20H    ; 32 ' '
 488  EB70 23                   INC   HL
 489  EB71 3D                   DEC   A
 490  EB72 C2 6E EB             JP    NZ,LBL25
 491  EB75 11 0A E8             LD    DE,LBL2             ; 53258
 492  EB78 2A 59 E8             LD    HL,(VAR3)
 493  EB7B 06 40                LD    B,40H         ; 64 '@'
 494  EB7D 7E           LBL26:  LD    A,(HL)
 495  EB7E FE 0D                CP    0DH           ; 13
 496  EB80 C8                   RET   Z
 497  EB81 FE FF                CP    0FFH          ; 255
 498  EB83 C8                   RET   Z
 499  EB84 05                   DEC   B
 500  EB85 C8                   RET   Z
 501  EB86 12                   LD    (DE),A
 502  EB87 23                   INC   HL
 503  EB88 13                   INC   DE
 504  EB89 C3 7D EB             JP    LBL26
 505  EB8C
 506  EB8C              keyHandler_Space:
 507  EB8C 2A 59 E8             LD    HL,(VAR3)
 508  EB8F CD D6 EA             CALL  SUB8
 509  EB92 DA 16 F2             JP    C,Beep4
 510  EB95 CD 60 EB             CALL  SUB12
 511  EB98 CD E4 EB             CALL  SUB13
 512  EB9B 3A 5C E8             LD    A,(VAR5)
 513  EB9E B7                   OR    A
 514  EB9F C2 B1 EB             JP    NZ,LBL28
 515  EBA2 71                   LD    (HL),C
 516  EBA3 CD 09 C8             CALL  bios_printChar
 517  EBA6 3A FD 8F             LD    A,(bios_vars.cursorY+1)
 518  EBA9 FE BD                CP    0BDH          ; 189
 519  EBAB C0                   RET   NZ
 520  EBAC 0E 08                LD    C,08H         ; 8
 521  EBAE C3 09 C8             JP    bios_printChar
 522  EBB1 11 49 E8     LBL28:  LD    DE,REF5             ; 53321
 523  EBB4 CD 57 EB             CALL  SkipSpaces
 524  EBB7 E5                   PUSH  HL
 525  EBB8 21 49 E8             LD    HL,REF5             ; 53321
 526  EBBB CD 09 F2             CALL  SUB38
 527  EBBE CA C2 EB             JP    Z,LBL29
 528  EBC1 13                   INC   DE
 529  EBC2 E1           LBL29:  POP   HL
 530  EBC3 CD 2C F2             CALL  SUB43
 531  EBC6 46           LBL30:  LD    B,(HL)
 532  EBC7 71                   LD    (HL),C
 533  EBC8 CD 09 C8             CALL  bios_printChar
 534  EBCB 48                   LD    C,B
 535  EBCC 23                   INC   HL
 536  EBCD CD 09 F2             CALL  SUB38
 537  EBD0 DA C6 EB             JP    C,LBL30
 538  EBD3 CD 35 F2             CALL  SUB44
 539  EBD6 0E 18                LD    C,18H         ; 24
 540  EBD8 C3 F8 EA             JP    LBL20
 541  EBDB
 542  EBDB              keyHandler_F1:
 543  EBDB 21 5C E8             LD    HL,VAR5             ; 53340
 544  EBDE 7E                   LD    A,(HL)
 545  EBDF 2F                   cpl
 546  EBE0 77                   LD    (HL),A
 547  EBE1 C3 D6 F2             JP    SUB47
 548  EBE4 21 0A E8     SUB13:  LD    HL,LBL2             ; 53258; [4]
 549  EBE7 3A FD 8F     SUB14:  LD    A,(bios_vars.cursorY+1)        ; [4]
 550  EBEA B7                   OR    A
 551  EBEB C8           LBL32:  RET   Z
 552  EBEC 23                   INC   HL
 553  EBED D6 03                SUB   03H           ; 3
 554  EBEF C3 EB EB             JP    LBL32
 555  EBF2
 556  EBF2              keyHandler_Del:
 557  EBF2 CD 60 EB             CALL  SUB12
 558  EBF5 CD E4 EB             CALL  SUB13
 559  EBF8 E5                   PUSH  HL
 560  EBF9 4D                   LD    C,L
 561  EBFA 44                   LD    B,H
 562  EBFB 03                   INC   BC
 563  EBFC 11 49 E8             LD    DE,REF5             ; 53321
 564  EBFF CD FE F1             CALL  SUB37
 565  EC02 E1                   POP   HL
 566  EC03 11 49 E8             LD    DE,REF5             ; 53321
 567  EC06 CD 57 EB             CALL  SkipSpaces
 568  EC09 E5                   PUSH  HL
 569  EC0A 21 49 E8             LD    HL,REF5             ; 53321
 570  EC0D CD 09 F2             CALL  SUB38
 571  EC10 CA 14 EC             JP    Z,LBL34
 572  EC13 13                   INC   DE
 573  EC14 E1           LBL34:  POP   HL
 574  EC15 CD 2C F2             CALL  SUB43
 575  EC18 4E           LBL35:  LD    C,(HL)
 576  EC19 CD 09 C8             CALL  bios_printChar
 577  EC1C CD 09 F2             CALL  SUB38
 578  EC1F 23                   INC   HL
 579  EC20 DA 18 EC             JP    C,LBL35
 580  EC23 C3 35 F2             JP    SUB44
 581  EC26
 582  EC26 3A 5B E8     SUB15:  LD    A,(VAR4)  ; читаем VAR4
 583  EC29 B7                   OR    A
 584  EC2A C8                   RET   Z         ; если VAR4 == 0, выходим
 585  EC2B AF                   XOR   A         ; инвертируем
 586  EC2C 32 5B E8             LD    (VAR4),A  ; сохраняем обртано
 587  EC2F C5                   PUSH  BC
 588  EC30 CD 54 EB             CALL  SUB10
 589  EC33 21 0A E8             LD    HL,LBL2
 590  EC36 CD 0F F2             CALL  SUB39
 591  EC39 2A 59 E8             LD    HL,(VAR3)
 592  EC3C EB                   EX    DE,HL
 593  EC3D 19                   ADD   HL,DE
 594  EC3E EB                   EX    DE,HL
 595  EC3F CD 21 F2             CALL  SUB42
 596  EC42 3C                   INC   A
 597  EC43 CA 47 EC             JP    Z,LBL36
 598  EC46 2B                   DEC   HL
 599  EC47 CD 58 EC     LBL36:  CALL  SUB16
 600  EC4A 2A 59 E8             LD    HL,(VAR3)
 601  EC4D 01 0A E8             LD    BC,LBL2             ; 53258
 602  EC50 CD 09 F2             CALL  SUB38
 603  EC53 C4 FE F1             CALL  NZ,SUB37
 604  EC56 C1                   POP   BC
 605  EC57 C9                   RET
 606  EC58 CD 09 F2     SUB16:  CALL  SUB38         ; [5]
 607  EC5B C8                   RET   Z
 608  EC5C F5                   PUSH  AF
 609  EC5D D5                   PUSH  DE
 610  EC5E CD 0F F2             CALL  SUB39
 611  EC61 42                   LD    B,D
 612  EC62 4B                   LD    C,E
 613  EC63 EB                   EX    DE,HL
 614  EC64 2A 5D E8             LD    HL,(VAR6)
 615  EC67 CD 09 F2             CALL  SUB38
 616  EC6A DA 71 EC             JP    C,LBL37
 617  EC6D 09                   ADD   HL,BC
 618  EC6E 22 5D E8             LD    (VAR6),HL
 619  EC71 2A 5F E8     LBL37:  LD    HL,(VAR7)
 620  EC74 EB                   EX    DE,HL
 621  EC75 CD 09 F2             CALL  SUB38
 622  EC78 EB                   EX    DE,HL
 623  EC79 D2 80 EC             JP    NC,LBL38
 624  EC7C 09                   ADD   HL,BC
 625  EC7D 22 5F E8             LD    (VAR7),HL
 626  EC80 EB           LBL38:  EX    DE,HL
 627  EC81 D1                   POP   DE
 628  EC82 F1                   POP   AF
 629  EC83 DA B5 EC             JP    C,LBL42
 630  EC86 D5                   PUSH  DE
 631  EC87 4B                   LD    C,E
 632  EC88 42                   LD    B,D
 633  EC89 EB                   EX    DE,HL
 634  EC8A 2A 57 E8             LD    HL,(VAR2)
 635  EC8D 23                   INC   HL
 636  EC8E EB                   EX    DE,HL
 637  EC8F CD 0F F2             CALL  SUB39
 638  EC92 7B           LBL39:  LD    A,E
 639  EC93 E6 FE                AND   0FEH          ; 254
 640  EC95 B2                   OR    D
 641  EC96 CA A6 EC             JP    Z,LBL40
 642  EC99 7E                   LD    A,(HL)
 643  EC9A 02                   LD    (BC),A
 644  EC9B 03                   INC   BC
 645  EC9C 23                   INC   HL
 646  EC9D 1B                   DEC   DE
 647  EC9E 7E                   LD    A,(HL)
 648  EC9F 02                   LD    (BC),A
 649  ECA0 03                   INC   BC
 650  ECA1 23                   INC   HL
 651  ECA2 1B                   DEC   DE
 652  ECA3 C3 92 EC             JP    LBL39
 653  ECA6 BB           LBL40:  CP    E
 654  ECA7 CA AD EC             JP    Z,LBL41
 655  ECAA 7E                   LD    A,(HL)
 656  ECAB 02                   LD    (BC),A
 657  ECAC 03                   INC   BC
 658  ECAD 0B           LBL41:  DEC   BC
 659  ECAE 69                   LD    L,C
 660  ECAF 60                   LD    H,B
 661  ECB0 22 57 E8             LD    (VAR2),HL
 662  ECB3 D1                   POP   DE
 663  ECB4 C9                   RET
 664  ECB5 D5           LBL42:  PUSH  DE
 665  ECB6 CD 0F F2             CALL  SUB39
 666  ECB9 2A 57 E8             LD    HL,(VAR2)
 667  ECBC 44                   LD    B,H
 668  ECBD 4D                   LD    C,L
 669  ECBE 19                   ADD   HL,DE
 670  ECBF D1                   POP   DE
 671  ECC0 D5                   PUSH  DE
 672  ECC1 E5                   PUSH  HL
 673  ECC2 EB                   EX    DE,HL
 674  ECC3 2A 08 E8             LD    HL,(VAR03)
 675  ECC6 CD 09 F2             CALL  SUB38
 676  ECC9 DA 80 EE             JP    C,LBL71
 677  ECCC E1                   POP   HL
 678  ECCD D1                   POP   DE
 679  ECCE 22 57 E8             LD    (VAR2),HL
 680  ECD1 E5                   PUSH  HL
 681  ECD2 EB                   EX    DE,HL
 682  ECD3 CD 0F F2             CALL  SUB39
 683  ECD6 E3                   EX    (SP),HL
 684  ECD7 13                   INC   DE
 685  ECD8 7B           LBL43:  LD    A,E
 686  ECD9 E6 FC                AND   0FCH          ; 252
 687  ECDB B2                   OR    D
 688  ECDC CA F6 EC             JP    Z,LBL44
 689  ECDF 0A                   LD    A,(BC)
 690  ECE0 77                   LD    (HL),A
 691  ECE1 2B                   DEC   HL
 692  ECE2 0B                   DEC   BC
 693  ECE3 1B                   DEC   DE
 694  ECE4 0A                   LD    A,(BC)
 695  ECE5 77                   LD    (HL),A
 696  ECE6 2B                   DEC   HL
 697  ECE7 0B                   DEC   BC
 698  ECE8 1B                   DEC   DE
 699  ECE9 0A                   LD    A,(BC)
 700  ECEA 77                   LD    (HL),A
 701  ECEB 2B                   DEC   HL
 702  ECEC 0B                   DEC   BC
 703  ECED 1B                   DEC   DE
 704  ECEE 0A                   LD    A,(BC)
 705  ECEF 77                   LD    (HL),A
 706  ECF0 2B                   DEC   HL
 707  ECF1 0B                   DEC   BC
 708  ECF2 1B                   DEC   DE
 709  ECF3 C3 D8 EC             JP    LBL43
 710  ECF6 7B           LBL44:  LD    A,E
 711  ECF7 B7                   OR    A
 712  ECF8 CA 03 ED             JP    Z,LBL46
 713  ECFB 0A           LBL45:  LD    A,(BC)
 714  ECFC 77                   LD    (HL),A
 715  ECFD 2B                   DEC   HL
 716  ECFE 0B                   DEC   BC
 717  ECFF 1D                   DEC   E
 718  ED00 C2 FB EC             JP    NZ,LBL45
 719  ED03 D1           LBL46:  POP   DE
 720  ED04 C9                   RET
 721  ED05
 722  ED05              keyHandler_Tab:
 723  ED05 CD F8 F1             CALL  SUB36
 724  ED08 CA 38 ED             JP    Z,LBL51
 725  ED0B 21 01 00             LD    HL,0001H    ; 1
 726  ED0E CD E7 EB             CALL  SUB14
 727  ED11 5D                   LD    E,L
 728  ED12 21 63 E8             LD    HL,REF7             ; 53347
 729  ED15 0E 03                LD    C,03H         ; 3
 730  ED17 AF                   XOR   A
 731  ED18 0D           LBL47:  DEC   C
 732  ED19 CA 30 ED             JP    Z,LBL50
 733  ED1C 86                   ADD   A,(HL)
 734  ED1D BB                   CP    E
 735  ED1E 23                   INC   HL
 736  ED1F DA 18 ED             JP    C,LBL47
 737  ED22 FE 3E        LBL48:  CP    3EH           ; 62 '>'; [2]
 738  ED24 DA 29 ED             JP    C,LBL49
 739  ED27 3E 3E                LD    A,3EH         ; 62 '>'
 740  ED29 6F           LBL49:  LD    L,A           ; [3]
 741  ED2A 87                   ADD   A,A
 742  ED2B 85                   ADD   A,L
 743  ED2C 32 FD 8F             LD    (bios_vars.cursorY+1),A
 744  ED2F C9                   RET
 745  ED30 86           LBL50:  ADD   A,(HL)                ; [2]
 746  ED31 BB                   CP    E
 747  ED32 DA 30 ED             JP    C,LBL50
 748  ED35 C3 22 ED             JP    LBL48
 749  ED38 21 00 00     LBL51:  LD    HL,0000H
 750  ED3B CD E7 EB             CALL  SUB14
 751  ED3E 5D                   LD    E,L
 752  ED3F 21 63 E8             LD    HL,REF7             ; 53347
 753  ED42 0E 03                LD    C,03H         ; 3
 754  ED44 AF                   XOR   A
 755  ED45 0D           LBL52:  DEC   C
 756  ED46 CA 54 ED             JP    Z,LBL53
 757  ED49 86                   ADD   A,(HL)
 758  ED4A BB                   CP    E
 759  ED4B 23                   INC   HL
 760  ED4C DA 45 ED             JP    C,LBL52
 761  ED4F 2B                   DEC   HL
 762  ED50 96                   SUB   (HL)
 763  ED51 C3 29 ED             JP    LBL49
 764  ED54 86           LBL53:  ADD   A,(HL)                ; [2]
 765  ED55 BB                   CP    E
 766  ED56 DA 54 ED             JP    C,LBL53
 767  ED59 96                   SUB   (HL)
 768  ED5A C3 29 ED             JP    LBL49
 769  ED5D
 770  ED5D              keyHandler_F2:
 771  ED5D CD 26 EC             CALL  SUB15         ; [2]
 772  ED60 2A 06 E8             LD    HL,(VAR01)
 773  ED63 EB                   EX    DE,HL
 774  ED64 2A 55 E8             LD    HL,(VAR1)
 775  ED67 06 16                LD    B,16H         ; 22
 776  ED69 CD 09 F2     LBL55:  CALL  SUB38
 777  ED6C CA 7B ED             JP    Z,LBL56
 778  ED6F CD 28 F1             CALL  SUB35
 779  ED72 E5                   PUSH  HL
 780  ED73 CD 13 F3             CALL  SUB49
 781  ED76 E1                   POP   HL
 782  ED77 05                   DEC   B
 783  ED78 C2 69 ED             JP    NZ,LBL55
 784  ED7B 22 55 E8     LBL56:  LD    (VAR1),HL
 785  ED7E CD 4C EA             CALL  SUB5
 786  ED81 C9                   RET
 787  ED82
 788  ED82              keyHandler_F3:
 789  ED82 CD 26 EC             CALL  SUB15
 790  ED85 2A 55 E8             LD    HL,(VAR1)
 791  ED88 01 19 16             LD    BC,1619H    ; 5657
 792  ED8B 5D           LBL58:  LD    E,L
 793  ED8C 54                   LD    D,H
 794  ED8D CD 21 F2             CALL  SUB42
 795  ED90 7E                   LD    A,(HL)
 796  ED91 3C                   INC   A
 797  ED92 C2 9A ED             JP    NZ,LBL59
 798  ED95 6B                   LD    L,E
 799  ED96 62                   LD    H,D
 800  ED97 C3 A6 ED             JP    LBL60
 801  ED9A E5           LBL59:  PUSH  HL
 802  ED9B CD FD F2             CALL  SUB48
 803  ED9E CC 09 C8             CALL  Z,bios_printChar
 804  EDA1 E1                   POP   HL
 805  EDA2 05                   DEC   B
 806  EDA3 C2 8B ED             JP    NZ,LBL58
 807  EDA6 22 55 E8     LBL60:  LD    (VAR1),HL
 808  EDA9 CD 4C EA             CALL  SUB5
 809  EDAC C9                   RET
 810  EDAD
 811  EDAD              keyHandler_Esc_End:
 812  EDAD CD FD F2             CALL  SUB48
 813  EDB0 C2 AD ED             JP    NZ,keyHandler_Esc_End
 814  EDB3 2A 59 E8             LD    HL,(VAR3)
 815  EDB6 22 55 E8             LD    (VAR1),HL
 816  EDB9 3E 08                LD    A,08H         ; 8
 817  EDBB 32 FC 8F             LD    (bios_vars.cursorY),A
 818  EDBE C3 5D ED             JP    keyHandler_F2
 819  EDC1
 820  EDC1              keyHandler_Esc_L:
 821  EDC1 21 74 EE             LD    HL,REF23    ; 54885
 822  EDC4 E5                   PUSH  HL
 823  EDC5 2A 5D E8             LD    HL,(VAR6)
 824  EDC8 7C                   LD    A,H
 825  EDC9 B5                   OR    L
 826  EDCA C2 D3 ED             JP    NZ,LBL62
 827  EDCD CD E1 ED             CALL  SUB17
 828  EDD0 C3 E8 ED             JP    LBL63
 829  EDD3
 830  EDD3 EB           LBL62:  EX    DE,HL
 831  EDD4 2A 59 E8             LD    HL,(VAR3)
 832  EDD7 CD 21 F2             CALL  SUB42
 833  EDDA EB                   EX    DE,HL
 834  EDDB CD 09 F2             CALL  SUB38
 835  EDDE DA E8 ED             JP    C,LBL63
 836  EDE1 2A 59 E8     SUB17:  LD    HL,(VAR3)
 837  EDE4 22 5D E8             LD    (VAR6),HL
 838  EDE7 C9                   RET
 839  EDE8
 840  EDE8 2A 59 E8     LBL63:  LD    HL,(VAR3)   ; [2]
 841  EDEB CD 21 F2             CALL  SUB42
 842  EDEE 22 5F E8             LD    (VAR7),HL
 843  EDF1 C9                   RET
 844  EDF2
 845  EDF2              keyHandler_Esc_D:
 846  EDF2 2A 5D E8             LD    HL,(VAR6)
 847  EDF5 7D                   LD    A,L
 848  EDF6 B4                   OR    H
 849  EDF7 CA 16 F2             JP    Z,Beep4
 850  EDFA EB                   EX    DE,HL
 851  EDFB 2A 59 E8             LD    HL,(VAR3)
 852  EDFE CD D6 EA     LBL64:  CALL  SUB8
 853  EE01 D2 0A EE             JP    NC,LBL65
 854  EE04 CD 28 F1             CALL  SUB35
 855  EE07 C2 FE ED             JP    NZ,LBL64
 856  EE0A 22 59 E8     LBL65:  LD    (VAR3),HL
 857  EE0D 21 00 00             LD    HL,0000H
 858  EE10 22 5D E8             LD    (VAR6),HL
 859  EE13 2A 5F E8             LD    HL,(VAR7)
 860  EE16 D5           LBL66:  PUSH  DE
 861  EE17 CD 0F F2             CALL  SUB39
 862  EE1A 42                   LD    B,D
 863  EE1B 4B                   LD    C,E
 864  EE1C EB                   EX    DE,HL
 865  EE1D 2A 55 E8             LD    HL,(VAR1)
 866  EE20 CD 09 F2             CALL  SUB38
 867  EE23 DA 2A EE             JP    C,LBL67
 868  EE26 09                   ADD   HL,BC
 869  EE27 22 55 E8             LD    (VAR1),HL
 870  EE2A 2A 59 E8     LBL67:  LD    HL,(VAR3)
 871  EE2D CD 09 F2             CALL  SUB38
 872  EE30 DA 37 EE             JP    C,LBL68
 873  EE33 09                   ADD   HL,BC
 874  EE34 22 59 E8             LD    (VAR3),HL
 875  EE37 EB           LBL68:  EX    DE,HL
 876  EE38 D1                   POP   DE
 877  EE39 CD 58 EC             CALL  SUB16
 878  EE3C CD 7A F3             CALL  SUB52
 879  EE3F 3A FC 8F             LD    A,(bios_vars.cursorY)
 880  EE42 D6 08                SUB   08H           ; 8
 881  EE44 47                   LD    B,A
 882  EE45 CA 55 EE             JP    Z,LBL70
 883  EE48 CD 28 F1     LBL69:  CALL  SUB35
 884  EE4B CC 5B EE             CALL  Z,SUB18
 885  EE4E 78                   LD    A,B
 886  EE4F D6 0A                SUB   0AH           ; 10
 887  EE51 47                   LD    B,A
 888  EE52 C2 48 EE             JP    NZ,LBL69
 889  EE55 22 55 E8     LBL70:  LD    (VAR1),HL
 890  EE58 C3 4C EA             JP    SUB5
 891  EE5B E5           SUB18:  PUSH  HL
 892  EE5C CD FD F2             CALL  SUB48
 893  EE5F E1                   POP   HL
 894  EE60 C0                   RET   NZ
 895  EE61 0E 19                LD    C,19H         ; 25
 896  EE63 C3 09 C8             JP    bios_printChar
 897  EE66
 898  EE66              keyHandler_Esc_U:
 899  EE66 2A 5D E8             LD    HL,(VAR6)
 900  EE69 11 00 00             LD    DE,0000H
 901  EE6C CD 09 F2             CALL  SUB38
 902  EE6F C8                   RET   Z
 903  EE70 EB                   EX    DE,HL
 904  EE71 22 5D E8             LD    (VAR6),HL
 905  EE74 CD 2C F2     REF23:  CALL  SUB43
 906  EE77 2A 55 E8             LD    HL,(VAR1)
 907  EE7A CD 2E EA             CALL  SUB3
 908  EE7D C3 35 F2             JP    SUB44
 909  EE80 21 67 E8     LBL71:  LD    HL,REF8             ; 53351; [2]
 910  EE83 CD 18 C8             CALL  bios_printString
 911  EE86 CD 16 F2             CALL  Beep4
 912  EE89 CD 03 C8             CALL  bios_getch
 913  EE8C C3 DD E8             JP    LBL5
 914  EE8F
 915  EE8F              keyHandler_Esc_O:
 916  EE8F 21 7A E8             LD    HL,REF9             ; 53370
 917  EE92 CD 18 C8             CALL  bios_printString
 918  EE95 CD 2A F0             CALL  SUB33
 919  EE98 C2 18 EA             JP    NZ,SUB1
 920  EE9B 2A 06 E8             LD    HL,(VAR01)
 921  EE9E CD 19 F0             CALL  SUB32
 922  EEA1 C5                   PUSH  BC
 923  EEA2 D5                   PUSH  DE
 924  EEA3 CD F1 EE             CALL  SUB19
 925  EEA6 E3                   EX    (SP),HL
 926  EEA7 EB                   EX    DE,HL
 927  EEA8 21 0A E8             LD    HL,LBL2
 928  EEAB 3E E6                LD    A,0E6H
 929  EEAD 06 05                LD    B,05H
 930  EEAF CD 1B EF     LBL72:  CALL  SUB24
 931  EEB2 05                   DEC   B
 932  EEB3 C2 AF EE             JP    NZ,LBL72
 933  EEB6 7E           LBL73:  LD    A,(HL)
 934  EEB7 CD 1B EF             CALL  SUB24
 935  EEBA B7                   OR    A
 936  EEBB CA C2 EE             JP    Z,LBL74
 937  EEBE 23                   INC   HL
 938  EEBF C3 B6 EE             JP    LBL73
 939  EEC2 CD 00 EF     LBL74:  CALL  SUB20
 940  EEC5 D1                   POP   DE
 941  EEC6 3A 06 E8             LD    A,(VAR01)
 942  EEC9 2F                   cpl
 943  EECA 3C                   INC   A
 944  EECB 6F                   LD    L,A
 945  EECC 3A 07 E8             LD    A,(VAR02)
 946  EECF 2F                   cpl
 947  EED0 3C                   INC   A
 948  EED1 67                   LD    H,A
 949  EED2 19                   ADD   HL,DE
 950  EED3 3E E6                LD    A,0E6H
 951  EED5 CD 1B EF             CALL  SUB24
 952  EED8 7D                   LD    A,L
 953  EED9 2F                   cpl
 954  EEDA CD 1B EF             CALL  SUB24
 955  EEDD 7C                   LD    A,H
 956  EEDE 2F                   cpl
 957  EEDF 2A 06 E8             LD    HL,(VAR01)
 958  EEE2 CD 0D EF             CALL  SUB23
 959  EEE5 C1                   POP   BC
 960  EEE6 79                   LD    A,C
 961  EEE7 CD 1B EF             CALL  SUB24
 962  EEEA 78                   LD    A,B
 963  EEEB CD 1B EF             CALL  SUB24
 964  EEEE C3 18 EA             JP    SUB1
 965  EEF1 16 04        SUB19:  LD    D,04H         ; 4
 966  EEF3 AF                   XOR   A
 967  EEF4 1E 40        LBL75:  LD    E,40H         ; 64 '@'
 968  EEF6 EE 55                XOR   55H           ; 85 'U'
 969  EEF8 CD 05 EF             CALL  SUB22
 970  EEFB 15                   DEC   D
 971  EEFC C2 F4 EE             JP    NZ,LBL75
 972  EEFF C9                   RET
 973  EF00 CD 03 EF     SUB20:  CALL  SUB21
 974  EF03 AF           SUB21:  XOR   A
 975  EF04 5F                   LD    E,A
 976  EF05 CD 1B EF     SUB22:  CALL  SUB24         ; [2]
 977  EF08 1D                   DEC   E
 978  EF09 C2 05 EF             JP    NZ,SUB22
 979  EF0C C9                   RET
 980  EF0D CD 1B EF     SUB23:  CALL  SUB24         ; [2]
 981  EF10 CD 09 F2             CALL  SUB38
 982  EF13 7E                   LD    A,(HL)
 983  EF14 23                   INC   HL
 984  EF15 C2 0D EF             JP    NZ,SUB23
 985  EF18 C3 1B EF             JP    SUB24
 986  EF1B 4F           SUB24:  LD    C,A           ; [9]
 987  EF1C C3 0C C8             JP    bios_tapeWrite
 988  EF1F
 989  EF1F              keyHandler_Esc_I:
 990  EF1F 06 00                LD    B,00H
 991  EF21
 992  EF21 78           LBL76:  LD    A,B           ; [2]
 993  EF22 32 66 E8             LD    (VAR9),A
 994  EF25 21 00 00             LD    HL,0000H
 995  EF28 22 5D E8             LD    (VAR6),HL
 996  EF2B 21 7A E8             LD    HL,REF9             ; 53370
 997  EF2E CD 18 C8             CALL  bios_printString
 998  EF31 CD 2A F0             CALL  SUB33
 999  EF34 C2 18 EA             JP    NZ,SUB1
1000  EF37 CD E4 EF             CALL  SUB31
1001  EF3A E5                   PUSH  HL
1002  EF3B CD DF EF     LBL77:  CALL  SUB30
1003  EF3E 47                   LD    B,A
1004  EF3F 3A 66 E8             LD    A,(VAR9)
1005  EF42 3C                   INC   A
1006  EF43 C2 4B EF             JP    NZ,LBL78
1007  EF46 78                   LD    A,B
1008  EF47 BE                   CP    (HL)
1009  EF48 C2 6B EF             JP    NZ,LBL79
1010  EF4B 70           LBL78:  LD    (HL),B
1011  EF4C 23                   INC   HL
1012  EF4D 04                   INC   B
1013  EF4E C2 3B EF             JP    NZ,LBL77
1014  EF51 3E 08                LD    A,08H
1015  EF53 CD BF EF             CALL  SUB28
1016  EF56 E1                   POP   HL
1017  EF57 C5                   PUSH  BC
1018  EF58 CD 19 F0             CALL  SUB32
1019  EF5B E3                   EX    (SP),HL
1020  EF5C 50                   LD    D,B
1021  EF5D 59                   LD    E,C
1022  EF5E CD 09 F2             CALL  SUB38
1023  EF61 C2 6B EF             JP    NZ,LBL79
1024  EF64 E1                   POP   HL
1025  EF65 22 57 E8             LD    (VAR2),HL
1026  EF68 C3 09 EA             JP    keyHandler_Esc_Home
1027  EF6B
1028  EF6B E1           LBL79:  POP   HL
1029  EF6C 21 88 E8             LD    HL,REF12
1030  EF6F CD 18 C8             CALL  bios_printString
1031  EF72 CD 16 F2             CALL  Beep4
1032  EF75 CD 03 C8             CALL  bios_getch
1033  EF78 2A 57 E8             LD    HL,(VAR2)
1034  EF7B 36 FF                LD    (HL),0FFH
1035  EF7D C3 09 EA             JP    keyHandler_Esc_Home
1036  EF80
1037  EF80 21 1A E8     SUB25:  LD    HL,SMC6+1 ; тут адрес перехода в п/п LBL3
1038  EF83 CD CC EF             CALL  SUB29
1039  EF86 CD DF EF     LBL80:  CALL  SUB30
1040  EF89 77                   LD    (HL),A
1041  EF8A B7                   OR    A
1042  EF8B CA 92 EF             JP    Z,LBL81
1043  EF8E 23                   INC   HL
1044  EF8F C3 86 EF             JP    LBL80
1045  EF92
1046  EF92 21 7B E8     LBL81:  LD    HL,REF10
1047  EF95 CD 18 C8             CALL  bios_printString
1048  EF98 21 1A E8             LD    HL,SMC6+1 ; тут адрес перехода в п/п LBL3
1049  EF9B E5                   PUSH  HL
1050  EF9C CD 18 C8             CALL  bios_printString
1051  EF9F CD B0 EF             CALL  SUB26
1052  EFA2 E1                   POP   HL
1053  EFA3 11 0A E8             LD    DE,LBL2
1054  EFA6 1A           LBL82:  LD    A,(DE)
1055  EFA7 B7                   OR    A
1056  EFA8 C8                   RET   Z
1057  EFA9 BE                   CP    (HL)
1058  EFAA 23                   INC   HL
1059  EFAB 13                   INC   DE
1060  EFAC CA A6 EF             JP    Z,LBL82
1061  EFAF C9                   RET
1062  EFB0 21 00 00     SUB26:  LD    HL,0000H
1063  EFB3 5D                   LD    E,L
1064  EFB4 54                   LD    D,H
1065  EFB5 2B           LBL83:  DEC   HL
1066  EFB6 CD 09 F2             CALL  SUB38
1067  EFB9 C8                   RET   Z
1068  EFBA C3 B5 EF             JP    LBL83
1069  EFBD 3E FF        SUB27:  LD    A,0FFH
1070  EFBF CD 06 C8     SUB28:  CALL  bios_tapeRead
1071  EFC2 4F                   LD    C,A
1072  EFC3 CD DF EF             CALL  SUB30
1073  EFC6 47                   LD    B,A
1074  EFC7 C9                   RET
1075  EFC8 AF           LBL84:  XOR   A
1076  EFC9 32 F3 8F             LD    (bios_vars.tapeInverse),A
1077  EFCC
1078  EFCC 06 04        SUB29:  LD    B,04H
1079  EFCE 3E FF                LD    A,0FFH
1080  EFD0 CD 06 C8     LBL85:  CALL  bios_tapeRead
1081  EFD3 FE E6                CP    0E6H
1082  EFD5 C2 C8 EF             JP    NZ,LBL84
1083  EFD8 05                   DEC   B
1084  EFD9 3E 08                LD    A,08H
1085  EFDB C2 D0 EF             JP    NZ,LBL85
1086  EFDE C9                   RET
1087  EFDF
1088  EFDF 3E 08        SUB30:  LD    A,08H
1089  EFE1 C3 06 C8             JP    bios_tapeRead
1090  EFE4
1091  EFE4 CD 80 EF     SUB31:  CALL  SUB25
1092  EFE7 C2 E4 EF             JP    NZ,SUB31
1093  EFEA CD BD EF             CALL  SUB27
1094  EFED 2A 06 E8             LD    HL,(VAR01)
1095  EFF0 3A 66 E8             LD    A,(VAR9)
1096  EFF3 3D                   DEC   A
1097  EFF4 FA FA EF             JP    M,LBL86
1098  EFF7 2A 57 E8             LD    HL,(VAR2)
1099  EFFA 78           LBL86:  LD    A,B
1100  EFFB 2F                   cpl
1101  EFFC 47                   LD    B,A
1102  EFFD 79                   LD    A,C
1103  EFFE 2F                   cpl
1104  EFFF 4F                   LD    C,A
1105  F000 E5                   PUSH  HL
1106  F001 EB                   EX    DE,HL
1107  F002 2A 08 E8             LD    HL,(VAR03)
1108  F005 EB                   EX    DE,HL
1109  F006 09                   ADD   HL,BC
1110  F007 CD 09 F2             CALL  SUB38
1111  F00A E1                   POP   HL
1112  F00B D8                   RET   C
1113  F00C C3 80 EE             JP    LBL71
1114  F00F
1115  F00F              keyHandler_Esc_V:
1116  F00F 06 FF                LD    B,0FFH                ; 255
1117  F011 C3 21 EF             JP    LBL76
1118  F014
1119  F014              keyHandler_Esc_G:
1120  F014 06 01                LD    B,01H         ; 1
1121  F016 C3 21 EF             JP    LBL76
1122  F019
1123  F019 01 00 00     SUB32:  LD    BC,0000H    ; [2]
1124  F01C 7E           LBL87:  LD    A,(HL)
1125  F01D FE FF                CP    0FFH          ; 255
1126  F01F C8                   RET   Z
1127  F020 81                   ADD   A,C
1128  F021 4F                   LD    C,A
1129  F022 3E 00                LD    A,00H
1130  F024 88                   ADC   A,B
1131  F025 47                   LD    B,A
1132  F026 23                   INC   HL
1133  F027 C3 1C F0             JP    LBL87
1134  F02A 06 30        SUB33:  LD    B,30H         ; 48 '0'; [2]
1135  F02C 21 0A E8             LD    HL,LBL2             ; 53258
1136  F02F 5D                   LD    E,L
1137  F030 54                   LD    D,H
1138  F031 CD 03 C8     LBL88:  CALL  bios_getch          ; [5]
1139  F034 FE 20        SUB34:  CP    20H           ; 32 ' '
1140  F036 DA 53 F0             JP    C,LBL90
1141  F039 05                   DEC   B
1142  F03A C2 41 F0             JP    NZ,LBL89
1143  F03D 04                   INC   B
1144  F03E C3 31 F0             JP    LBL88
1145  F041 4F           LBL89:  LD    C,A
1146  F042 CD 09 C8             CALL  bios_printChar
1147  F045 77                   LD    (HL),A
1148  F046 23                   INC   HL
1149  F047 C3 31 F0             JP    LBL88
1150  F04A 01 20 2A             LD    BC,2A20H    ; 10784
1151  F04D CD 1D EB             CALL  keyHandler_Home
1152  F050 C3 19 F2             JP    TypeCharCtimesB
1153  F053 FE 1F        LBL90:  CP    1FH           ; 31
1154  F055 C2 5A F0             JP    NZ,LBL91
1155  F058 B7                   OR    A
1156  F059 C9                   RET
1157  F05A FE 08        LBL91:  CP    08H           ; 8
1158  F05C C2 72 F0             JP    NZ,LBL92
1159  F05F CD 09 F2             CALL  SUB38
1160  F062 CA 31 F0             JP    Z,LBL88
1161  F065 E5                   PUSH  HL
1162  F066 21 84 E8             LD    HL,REF11    ; 53380
1163  F069 CD 18 C8             CALL  bios_printString
1164  F06C E1                   POP   HL
1165  F06D 2B                   DEC   HL
1166  F06E 04                   INC   B
1167  F06F C3 31 F0             JP    LBL88
1168  F072 FE 0D        LBL92:  CP    0DH           ; 13
1169  F074 C2 31 F0             JP    NZ,LBL88
1170  F077 AF                   XOR   A
1171  F078 77                   LD    (HL),A
1172  F079 C9                   RET
1173  F07A
1174  F07A              keyHandler_F7:
1175  F07A CD 26 EC             CALL  SUB15
1176  F07D 21 F9 06             LD    HL,06F9H    ; 1785
1177  F080 22 FC 8F             LD    (bios_vars.cursorY),HL
1178  F083 CD 68 F4             CALL  SUB56
1179  F086 21 93 E8             LD    HL,REF13    ; 53395
1180  F089 CD 18 C8             CALL  bios_printString
1181  F08C 21 F9 1E             LD    HL,1EF9H    ; 7929
1182  F08F 22 FC 8F             LD    (bios_vars.cursorY),HL
1183  F092 CD 03 C8             CALL  bios_getch
1184  F095 FE 0D                CP    0DH           ; 13
1185  F097 CA B5 F0             JP    Z,LBL93
1186  F09A 01 20 10             LD    BC,1020H    ; 4128
1187  F09D CD 19 F2             CALL  TypeCharCtimesB
1188  F0A0 22 FC 8F             LD    (bios_vars.cursorY),HL
1189  F0A3 21 9B E8             LD    HL,REF14    ; 53403
1190  F0A6 5D                   LD    E,L
1191  F0A7 54                   LD    D,H
1192  F0A8 06 0F                LD    B,0FH         ; 15
1193  F0AA CD 34 F0             CALL  SUB34
1194  F0AD F5                   PUSH  AF
1195  F0AE CD 71 F4             CALL  SUB57
1196  F0B1 F1                   POP   AF
1197  F0B2 C2 18 EA             JP    NZ,SUB1
1198  F0B5 CD 71 F4     LBL93:  CALL  SUB57
1199  F0B8 2A 55 E8             LD    HL,(VAR1)
1200  F0BB CD 21 F2             CALL  SUB42
1201  F0BE 11 9B E8     LBL94:  LD    DE,REF14    ; 53403
1202  F0C1 46           LBL95:  LD    B,(HL)
1203  F0C2 1A                   LD    A,(DE)
1204  F0C3 B7                   OR    A
1205  F0C4 CA D7 F0             JP    Z,LBL96
1206  F0C7 B8                   CP    B
1207  F0C8 23                   INC   HL
1208  F0C9 13                   INC   DE
1209  F0CA CA C1 F0             JP    Z,LBL95
1210  F0CD 04                   INC   B
1211  F0CE C2 BE F0             JP    NZ,LBL94
1212  F0D1 CD 16 F2             CALL  Beep4
1213  F0D4 C3 09 EA             JP    keyHandler_Esc_Home
1214  F0D7 CD 28 F1     LBL96:  CALL  SUB35
1215  F0DA 22 55 E8             LD    (VAR1),HL
1216  F0DD 22 59 E8             LD    (VAR3),HL
1217  F0E0 CD 7A F3             CALL  SUB52
1218  F0E3 C3 18 EA             JP    SUB1
1219  F0E6
1220  F0E6              keyHandler_Esc_J:
1221  F0E6 CD 60 EB             CALL  SUB12
1222  F0E9 CD 54 EB             CALL  SUB10
1223  F0EC 2A 59 E8             LD    HL,(VAR3)
1224  F0EF CD 21 F2             CALL  SUB42
1225  F0F2 7E                   LD    A,(HL)
1226  F0F3 3C                   INC   A
1227  F0F4 C8                   RET   Z
1228  F0F5 2B                   DEC   HL
1229  F0F6 36 20                LD    (HL),20H    ; 32 ' '
1230  F0F8 23                   INC   HL
1231  F0F9 4D                   LD    C,L
1232  F0FA 44                   LD    B,H
1233  F0FB 21 47 E8             LD    HL,REF3             ; 53319
1234  F0FE CD 09 F2     LBL97:  CALL  SUB38
1235  F101 DA 49 EA             JP    C,LBL15
1236  F104 0A                   LD    A,(BC)
1237  F105 FE 0D                CP    0DH           ; 13
1238  F107 CA 49 EA             JP    Z,LBL15
1239  F10A FE FF                CP    0FFH          ; 255
1240  F10C CA 49 EA             JP    Z,LBL15
1241  F10F 12                   LD    (DE),A
1242  F110 13                   INC   DE
1243  F111 03                   INC   BC
1244  F112 C3 FE F0             JP    LBL97
1245  F115
1246  F115              keyHandler_Esc_S:
1247  F115 2A 59 E8             LD    HL,(VAR3)
1248  F118 CD E7 EB             CALL  SUB14
1249  F11B 5D                   LD    E,L
1250  F11C 54                   LD    D,H
1251  F11D 13                   INC   DE
1252  F11E E5                   PUSH  HL
1253  F11F CD 58 EC             CALL  SUB16
1254  F122 E1                   POP   HL
1255  F123 36 0D                LD    (HL),0DH    ; 13
1256  F125 C3 4C EA             JP    SUB5
1257  F128
1258  F128 D5           SUB35:  PUSH  DE            ; [6]
1259  F129 EB                   EX    DE,HL
1260  F12A 2A 06 E8             LD    HL,(VAR01)
1261  F12D EB                   EX    DE,HL
1262  F12E CD 09 F2             CALL  SUB38
1263  F131 CA 4C F1             JP    Z,LBL101
1264  F134 2B                   DEC   HL
1265  F135 CD 09 F2             CALL  SUB38
1266  F138 CA 4A F1             JP    Z,LBL100
1267  F13B 2B                   DEC   HL
1268  F13C 7E           LBL98:  LD    A,(HL)
1269  F13D FE 0D                CP    0DH           ; 13
1270  F13F CA 49 F1             JP    Z,LBL99
1271  F142 CD 09 F2             CALL  SUB38
1272  F145 2B                   DEC   HL
1273  F146 C2 3C F1             JP    NZ,LBL98
1274  F149
1275  F149 23           LBL99:  INC   HL
1276  F14A AF           LBL100: XOR   A
1277  F14B 3C                   INC   A
1278  F14C
1279  F14C D1           LBL101: POP   DE
1280  F14D C9                   RET
1281  F14E
1282  F14E              keyHandler_Esc_C:
1283  F14E 2A 5F E8             LD    HL,(VAR7)
1284  F151 EB                   EX    DE,HL
1285  F152 2A 5D E8             LD    HL,(VAR6)
1286  F155 7C                   LD    A,H
1287  F156 B5                   OR    L
1288  F157 CA 16 F2             JP    Z,Beep4
1289  F15A CD 0F F2             CALL  SUB39
1290  F15D 2A 59 E8             LD    HL,(VAR3)
1291  F160 CD D6 EA             CALL  SUB8
1292  F163 F5                   PUSH  AF
1293  F164 CD 21 F2             CALL  SUB42
1294  F167 F1                   POP   AF
1295  F168 DC D6 EA             CALL  C,SUB8
1296  F16B DA 16 F2             JP    C,Beep4
1297  F16E E5                   PUSH  HL
1298  F16F EB                   EX    DE,HL
1299  F170 19                   ADD   HL,DE
1300  F171 EB                   EX    DE,HL
1301  F172 CD 58 EC             CALL  SUB16
1302  F175 2A 5D E8             LD    HL,(VAR6)
1303  F178 4D                   LD    C,L
1304  F179 44                   LD    B,H
1305  F17A E1                   POP   HL
1306  F17B CD FE F1             CALL  SUB37
1307  F17E C3 4C EA             JP    SUB5
1308  F181
1309  F181              keyHandler_Esc_M:
1310  F181 2A 5F E8             LD    HL,(VAR7)
1311  F184 EB                   EX    DE,HL
1312  F185 2A 5D E8             LD    HL,(VAR6)
1313  F188 7C                   LD    A,H
1314  F189 B5                   OR    L
1315  F18A CA 16 F2             JP    Z,Beep4
1316  F18D CD 0F F2             CALL  SUB39
1317  F190 2A 59 E8             LD    HL,(VAR3)
1318  F193 CD D6 EA             CALL  SUB8
1319  F196 DA 16 F2             JP    C,Beep4
1320  F199 CD 21 F2             CALL  SUB42
1321  F19C E5                   PUSH  HL
1322  F19D EB                   EX    DE,HL
1323  F19E 19                   ADD   HL,DE
1324  F19F EB                   EX    DE,HL
1325  F1A0 C1                   POP   BC
1326  F1A1 D5                   PUSH  DE
1327  F1A2 E5                   PUSH  HL
1328  F1A3 C5                   PUSH  BC
1329  F1A4 CD 58 EC             CALL  SUB16
1330  F1A7 2A 5D E8             LD    HL,(VAR6)
1331  F1AA 4D                   LD    C,L
1332  F1AB 44                   LD    B,H
1333  F1AC E1                   POP   HL
1334  F1AD CD FE F1             CALL  SUB37
1335  F1B0 2A 5D E8             LD    HL,(VAR6)
1336  F1B3 EB                   EX    DE,HL
1337  F1B4 E1                   POP   HL
1338  F1B5 22 5D E8             LD    (VAR6),HL
1339  F1B8 2A 5F E8             LD    HL,(VAR7)
1340  F1BB E3                   EX    (SP),HL
1341  F1BC 22 5F E8             LD    (VAR7),HL
1342  F1BF E1                   POP   HL
1343  F1C0 C3 16 EE             JP    LBL66
1344  F1C3
1345  F1C3              keyHandler_Esc_N:
1346  F1C3 21 AB E8             LD    HL,txtNew    ; 53419
1347  F1C6 CD 18 C8             CALL  bios_printString
1348  F1C9 CD 03 C8             CALL  bios_getch
1349  F1CC FE 59                CP    59H           ; 89 'Y'
1350  F1CE C2 18 EA             JP    NZ,SUB1
1351  F1D1 2A 06 E8             LD    HL,(VAR01)
1352  F1D4 36 0D                LD    (HL),0DH    ; 13
1353  F1D6 23                   INC   HL
1354  F1D7 36 FF                LD    (HL),0FFH   ; 255
1355  F1D9 22 57 E8             LD    (VAR2),HL
1356  F1DC C3 09 EA             JP    keyHandler_Esc_Home
1357  F1DF
1358  F1DF              keyHandler_F8:
1359  F1DF AF                   XOR   A
1360  F1E0 32 5B E8             LD    (VAR4),A
1361  F1E3 CD 2C F2             CALL  SUB43
1362  F1E6 CD 1D EB             CALL  keyHandler_Home
1363  F1E9 01 20 3F             LD    BC,3F20H    ; 16160
1364  F1EC CD 19 F2             CALL  TypeCharCtimesB
1365  F1EF 2A 59 E8             LD    HL,(VAR3)
1366  F1F2 CD A8 EA             CALL  SUB7
1367  F1F5 C3 35 F2             JP    SUB44
1368  F1F8 3A E1 FF     SUB36:  LD    A,(IO_KEYB_B) ; [3]
1369  F1FB E6 02                AND   02H           ; 2
1370  F1FD C9                   RET
1371  F1FE 0A           SUB37:  LD    A,(BC)        ; [5]
1372  F1FF 77                   LD    (HL),A
1373  F200 23                   INC   HL
1374  F201 03                   INC   BC
1375  F202 CD 09 F2             CALL  SUB38
1376  F205 C2 FE F1             JP    NZ,SUB37
1377  F208 C9                   RET
1378  F209 7C           SUB38:  LD    A,H           ; [34]
1379  F20A BA                   CP    D
1380  F20B C0                   RET   NZ
1381  F20C 7D                   LD    A,L
1382  F20D BB                   CP    E
1383  F20E C9                   RET
1384  F20F 7B           SUB39:  LD    A,E           ; [9]
1385  F210 95                   SUB   L
1386  F211 5F                   LD    E,A
1387  F212 7A                   LD    A,D
1388  F213 9C                   SBC   A,H
1389  F214 57                   LD    D,A
1390  F215 C9                   RET
1391  F216
1392  F216                      ; Звуковой сигнал 4 раза через п/п печати символа 07h
1393  F216              Beep4:
1394  F216 01 07 04             LD    BC,0407H      ; b = счетчик цикла, c = код символа
1395  F219
1396  F219                      ; Печать b раз символа с кодом c
1397  F219              TypeCharCtimesB:
1398  F219 CD 09 C8             CALL  bios_printChar
1399  F21C 05                   DEC   B
1400  F21D C2 19 F2             JP    NZ,TypeCharCtimesB
1401  F220 C9                   RET
1402  F221
1403  F221 7E           SUB42:  LD    A,(HL)                ; [11]
1404  F222 FE FF                CP    0FFH          ; 255
1405  F224 C8                   RET   Z
1406  F225 FE 0D                CP    0DH           ; 13
1407  F227 23                   INC   HL
1408  F228 C2 21 F2             JP    NZ,SUB42
1409  F22B C9                   RET
1410  F22C E5           SUB43:  PUSH  HL            ; [7]
1411  F22D 2A FC 8F             LD    HL,(bios_vars.cursorY)
1412  F230 22 37 F2             LD    (SMC2+1),HL
1413  F233 E1                   POP   HL
1414  F234 C9                   RET
1415  F235 E5           SUB44:  PUSH  HL            ; [7]
1416  F236 21 00 00     SMC2:   LD    HL,0000H
1417  F239 22 FC 8F             LD    (bios_vars.cursorY),HL
1418  F23C E1                   POP   HL
1419  F23D C9                   RET
1420  F23E CD DA F3     LBL103: CALL  SUB54
1421  F241 CD 28 F1             CALL  SUB35
1422  F244 22 59 E8             LD    (VAR3),HL
1423  F247 22 55 E8             LD    (VAR1),HL
1424  F24A CD 7A F3             CALL  SUB52
1425  F24D CD 97 F3             CALL  SUB53
1426  F250 CD 2E EA             CALL  SUB3
1427  F253 CD 03 C8             CALL  bios_getch
1428  F256 F5                   PUSH  AF
1429  F257 21 F9 06             LD    HL,06F9H    ; 1785
1430  F25A 22 FC 8F             LD    (bios_vars.cursorY),HL
1431  F25D 01 20 30             LD    BC,3020H    ; 12320
1432  F260 CD 19 F2             CALL  TypeCharCtimesB
1433  F263 CD 41 EA             CALL  SUB4
1434  F266 F1                   POP   AF
1435  F267 21 24 E9             LD    HL,REF21    ; 53535
1436  F26A E5                   PUSH  HL
1437  F26B C3 57 E9             JP    keyInput2
1438  F26E 26 90        SUB45:  LD    H,90H         ; 144
1439  F270 54                   LD    D,H
1440  F271 0E 39        LBL104: LD    C,39H         ; 57 '9'
1441  F273 2E 01                LD    L,01H         ; 1
1442  F275 1E 0B                LD    E,0BH         ; 11
1443  F277 1A           LBL105: LD    A,(DE)
1444  F278 77                   LD    (HL),A
1445  F279 23                   INC   HL
1446  F27A 13                   INC   DE
1447  F27B 1A                   LD    A,(DE)
1448  F27C 77                   LD    (HL),A
1449  F27D 23                   INC   HL
1450  F27E 13                   INC   DE
1451  F27F 1A                   LD    A,(DE)
1452  F280 77                   LD    (HL),A
1453  F281 23                   INC   HL
1454  F282 13                   INC   DE
1455  F283 1A                   LD    A,(DE)
1456  F284 77                   LD    (HL),A
1457  F285 23                   INC   HL
1458  F286 13                   INC   DE
1459  F287 0D                   DEC   C
1460  F288 C2 77 F2             JP    NZ,LBL105
1461  F28B 0E 0A                LD    C,0AH         ; 10
1462  F28D AF                   XOR   A
1463  F28E 77           LBL106: LD    (HL),A
1464  F28F 23                   INC   HL
1465  F290 0D                   DEC   C
1466  F291 C2 8E F2             JP    NZ,LBL106
1467  F294 7C                   LD    A,H
1468  F295 FE BF                CP    0BFH          ; 191
1469  F297 C8                   RET   Z
1470  F298 24                   INC   H
1471  F299 14                   INC   D
1472  F29A C3 71 F2             JP    LBL104
1473  F29D 3A FC 8F     SUB46:  LD    A,(bios_vars.cursorY)  ; [2]
1474  F2A0 6F                   LD    L,A
1475  F2A1 3E EE                LD    A,0EEH                ; 238
1476  F2A3 95                   SUB   L
1477  F2A4 B7                   OR    A
1478  F2A5 1F                   rra
1479  F2A6 32 B3 F2             LD    (SMC3+1),A
1480  F2A9 26 BF                LD    H,0BFH                ; 191
1481  F2AB 54                   LD    D,H
1482  F2AC 06 30                LD    B,30H         ; 48 '0'
1483  F2AE 2E EF        LBL107: LD    L,0EFH                ; 239
1484  F2B0 1E E5                LD    E,0E5H                ; 229
1485  F2B2 3E 00        SMC3:   LD    A,00H
1486  F2B4 4F                   LD    C,A
1487  F2B5 B7                   OR    A
1488  F2B6 CA C5 F2             JP    Z,LBL109
1489  F2B9 1A           LBL108: LD    A,(DE)
1490  F2BA 77                   LD    (HL),A
1491  F2BB 2B                   DEC   HL
1492  F2BC 1B                   DEC   DE
1493  F2BD 1A                   LD    A,(DE)
1494  F2BE 77                   LD    (HL),A
1495  F2BF 2B                   DEC   HL
1496  F2C0 1B                   DEC   DE
1497  F2C1 0D                   DEC   C
1498  F2C2 C2 B9 F2             JP    NZ,LBL108
1499  F2C5 0E 09        LBL109: LD    C,09H         ; 9
1500  F2C7 AF                   XOR   A
1501  F2C8 77           LBL110: LD    (HL),A
1502  F2C9 2B                   DEC   HL
1503  F2CA 1B                   DEC   DE
1504  F2CB 0D                   DEC   C
1505  F2CC C2 C8 F2             JP    NZ,LBL110
1506  F2CF 25                   DEC   H
1507  F2D0 54                   LD    D,H
1508  F2D1 05                   DEC   B
1509  F2D2 C2 AE F2             JP    NZ,LBL107
1510  F2D5 C9                   RET
1511  F2D6
1512  F2D6                      ; Обновление стаус бара
1513  F2D6 E5           SUB47:  PUSH  HL
1514  F2D7 2A FC 8F             LD    HL,(bios_vars.cursorY)
1515  F2DA E5                   PUSH  HL
1516  F2DB CD 68 F4             CALL  SUB56
1517  F2DE 21 F9 9D             LD    HL,9DF9H    ; 40441
1518  F2E1 22 FC 8F             LD    (bios_vars.cursorY),HL
1519  F2E4 3A 5C E8             LD    A,(VAR5)
1520  F2E7 B7                   OR    A
1521  F2E8 21 B4 E8             LD    HL,txtIns
1522  F2EB C2 F1 F2             JP    NZ,LBL111
1523  F2EE 21 BE E8             LD    HL,txtOvr
1524  F2F1 CD 18 C8     LBL111: CALL  bios_printString
1525  F2F4 CD 71 F4             CALL  SUB57
1526  F2F7 E1                   POP   HL
1527  F2F8 22 FC 8F             LD    (bios_vars.cursorY),HL
1528  F2FB E1                   POP   HL
1529  F2FC C9                   RET
1530  F2FD
1531  F2FD 2A 59 E8     SUB48:  LD    HL,(VAR3)   ; [5]
1532  F300 CD 21 F2             CALL  SUB42
1533  F303 7E                   LD    A,(HL)
1534  F304 3C                   INC   A
1535  F305 C8                   RET   Z
1536  F306 22 59 E8             LD    (VAR3),HL
1537  F309 2A 61 E8             LD    HL,(VAR8)
1538  F30C 23                   INC   HL
1539  F30D 22 61 E8             LD    (VAR8),HL
1540  F310 AF                   XOR   A
1541  F311 3C                   INC   A
1542  F312 C9                   RET
1543  F313 2A 59 E8     SUB49:  LD    HL,(VAR3)   ; [3]
1544  F316 CD 28 F1             CALL  SUB35
1545  F319 C8                   RET   Z
1546  F31A 22 59 E8             LD    (VAR3),HL
1547  F31D 2A 61 E8             LD    HL,(VAR8)
1548  F320 2B                   DEC   HL
1549  F321 22 61 E8             LD    (VAR8),HL
1550  F324 C9                   RET
1551  F325 D5           SUB50:  PUSH  DE            ; [3]
1552  F326 C5                   PUSH  BC
1553  F327 E5                   PUSH  HL
1554  F328 2A FC 8F             LD    HL,(bios_vars.cursorY)
1555  F32B E5                   PUSH  HL
1556  F32C CD 68 F4             CALL  SUB56
1557  F32F 21 F9 67             LD    HL,67F9H    ; 26617
1558  F332 22 FC 8F             LD    (bios_vars.cursorY),HL
1559  F335 2A 61 E8             LD    HL,(VAR8)
1560  F338 06 20                LD    B,20H         ; 32 ' '
1561  F33A 11 18 FC             LD    DE,0FC18H   ; 64536
1562  F33D CD 66 F3             CALL  SUB51
1563  F340 11 E8 03             LD    DE,03E8H    ; 1000
1564  F343 19                   ADD   HL,DE
1565  F344 11 9C FF             LD    DE,0FF9CH   ; 65436
1566  F347 CD 66 F3             CALL  SUB51
1567  F34A 11 64 00             LD    DE,0064H    ; 100
1568  F34D 19                   ADD   HL,DE
1569  F34E 11 F6 FF             LD    DE,0FFF6H   ; 65526
1570  F351 CD 66 F3             CALL  SUB51
1571  F354 7D                   LD    A,L
1572  F355 C6 3A                ADD   A,3AH         ; 58 ':'
1573  F357 4F                   LD    C,A
1574  F358 CD 09 C8             CALL  bios_printChar
1575  F35B CD 71 F4             CALL  SUB57
1576  F35E E1                   POP   HL
1577  F35F 22 FC 8F             LD    (bios_vars.cursorY),HL
1578  F362 E1                   POP   HL
1579  F363 C1                   POP   BC
1580  F364 D1                   POP   DE
1581  F365 C9                   RET
1582  F366 0E 2F        SUB51:  LD    C,2FH         ; 47 '/'; [4]
1583  F368 0C           LBL112: INC   C
1584  F369 19                   ADD   HL,DE
1585  F36A DA 68 F3             JP    C,LBL112
1586  F36D 79                   LD    A,C
1587  F36E FE 30                CP    30H           ; 48 '0'
1588  F370 CA 75 F3             JP    Z,LBL113
1589  F373 06 FF                LD    B,0FFH                ; 255
1590  F375 A0           LBL113: AND   B
1591  F376 4F                   LD    C,A
1592  F377 C3 09 C8             JP    bios_printChar
1593  F37A 2A 59 E8     SUB52:  LD    HL,(VAR3)   ; [3]
1594  F37D EB                   EX    DE,HL
1595  F37E 2A 06 E8             LD    HL,(VAR01)
1596  F381 22 59 E8             LD    (VAR3),HL
1597  F384 21 01 00             LD    HL,0001H    ; 1
1598  F387 22 61 E8             LD    (VAR8),HL
1599  F38A 2A 59 E8     LBL114: LD    HL,(VAR3)
1600  F38D CD 09 F2             CALL  SUB38
1601  F390 C8                   RET   Z
1602  F391 CD FD F2             CALL  SUB48
1603  F394 C3 8A F3             JP    LBL114
1604  F397 E5           SUB53:  PUSH  HL            ; [2]
1605  F398 2A FC 8F             LD    HL,(bios_vars.cursorY)
1606  F39B E5                   PUSH  HL
1607  F39C CD 68 F4             CALL  SUB56
1608  F39F 26 90                LD    H,90H
1609  F3A1 0E 30                LD    C,30H
1610  F3A3 2E F1        LBL115: LD    L,0F1H
1611  F3A5 3E 09                LD    A,09H
1612  F3A7 36 FF        LBL116: LD    (HL),0FFH
1613  F3A9 2C                   INC   L
1614  F3AA 3D                   DEC   A
1615  F3AB C2 A7 F3             JP    NZ,LBL116
1616  F3AE 24                   INC   H
1617  F3AF 0D                   DEC   C
1618  F3B0 C2 A3 F3             JP    NZ,LBL115
1619  F3B3 21 F9 58             LD    HL,58F9H
1620  F3B6 22 FC 8F             LD    (bios_vars.cursorY),HL
1621  F3B9 21 C8 E8             LD    HL,txtLine
1622  F3BC CD 18 C8             CALL  bios_printString
1623  F3BF 21 F9 80             LD    HL,80F9H
1624  F3C2 22 FC 8F             LD    (bios_vars.cursorY),HL
1625  F3C5 21 CD E8             LD    HL,txtCol
1626  F3C8 CD 18 C8             CALL  bios_printString
1627  F3CB CD 25 F3             CALL  SUB50
1628  F3CE CD D6 F2             CALL  SUB47
1629  F3D1 CD 71 F4             CALL  SUB57
1630  F3D4 E1                   POP   HL
1631  F3D5 22 FC 8F             LD    (bios_vars.cursorY),HL
1632  F3D8 E1                   POP   HL
1633  F3D9 C9                   RET
1634  F3DA
1635  F3DA E1           SUB54:  POP   HL
1636  F3DB
1637  F3DB                      ; Установка указателя стека, агрумент этой инструкции
1638  F3DB                      ; может меняться из п/п LBL4
1639  F3DB 31 50 8F     SMC4:   LD    SP,8F50H
1640  F3DE                      ; Переход по адресу в hl
1641  F3DE E9                   JP    (HL)
1642  F3DF
1643  F3DF CD 60 EB     LBL117: CALL  SUB12
1644  F3E2 CD E4 EB             CALL  SUB13
1645  F3E5 11 48 E8             LD    DE,REF4             ; 53320
1646  F3E8 0E 18                LD    C,18H         ; 24
1647  F3EA CD 09 F2     LBL118: CALL  SUB38
1648  F3ED C8                   RET   Z
1649  F3EE 7E                   LD    A,(HL)
1650  F3EF FE 20                CP    20H           ; 32 ' '
1651  F3F1 CA FB F3             JP    Z,LBL119
1652  F3F4 23                   INC   HL
1653  F3F5 CD 09 C8             CALL  bios_printChar
1654  F3F8 C3 EA F3             JP    LBL118
1655  F3FB CD 09 F2     LBL119: CALL  SUB38         ; [2]
1656  F3FE CA 0D EB             JP    Z,keyHandler_End
1657  F401 7E                   LD    A,(HL)
1658  F402 FE 20                CP    20H           ; 32 ' '
1659  F404 C0                   RET   NZ
1660  F405 23                   INC   HL
1661  F406 CD 09 C8             CALL  bios_printChar
1662  F409 C3 FB F3             JP    LBL119
1663  F40C CD 60 EB     LBL120: CALL  SUB12
1664  F40F CD E4 EB             CALL  SUB13
1665  F412 11 0A E8             LD    DE,LBL2             ; 53258
1666  F415 0E 08                LD    C,08H         ; 8
1667  F417 CD 09 F2             CALL  SUB38
1668  F41A C8                   RET   Z
1669  F41B 2B                   DEC   HL
1670  F41C 1B                   DEC   DE
1671  F41D CD 09 F2     LBL121: CALL  SUB38
1672  F420 C8                   RET   Z
1673  F421 7E                   LD    A,(HL)
1674  F422 FE 20                CP    20H           ; 32 ' '
1675  F424 C2 2E F4             JP    NZ,LBL122
1676  F427 CD 09 C8             CALL  bios_printChar
1677  F42A 2B                   DEC   HL
1678  F42B C3 1D F4             JP    LBL121
1679  F42E CD 09 F2     LBL122: CALL  SUB38         ; [2]
1680  F431 C8                   RET   Z
1681  F432 7E                   LD    A,(HL)
1682  F433 FE 20                CP    20H           ; 32 ' '
1683  F435 C8                   RET   Z
1684  F436 2B                   DEC   HL
1685  F437 CD 09 C8             CALL  bios_printChar
1686  F43A C3 2E F4             JP    LBL122
1687  F43D E5           SUB55:  PUSH  HL
1688  F43E D5                   PUSH  DE
1689  F43F 21 00 00             LD    HL,0000H
1690  F442 39                   ADD   HL,SP
1691  F443 22 63 F4             LD    (SMC5+1),HL
1692  F446 11 00 00             LD    DE,0000H
1693  F449 21 F0 BF             LD    HL,0BFF0H   ; 49136
1694  F44C 0E 30                LD    C,30H         ; 48 '0'
1695  F44E F9           LBL123: LD    SP,HL
1696  F44F 3E 0F                LD    A,0FH         ; 15
1697  F451 D5           LBL124: PUSH  DE
1698  F452 D5                   PUSH  DE
1699  F453 D5                   PUSH  DE
1700  F454 D5                   PUSH  DE
1701  F455 D5                   PUSH  DE
1702  F456 D5                   PUSH  DE
1703  F457 D5                   PUSH  DE
1704  F458 D5                   PUSH  DE
1705  F459 3D                   DEC   A
1706  F45A C2 51 F4             JP    NZ,LBL124
1707  F45D 25                   DEC   H
1708  F45E 0D                   DEC   C
1709  F45F C2 4E F4             JP    NZ,LBL123
1710  F462 31 FF FF     SMC5:   LD    SP,0FFFFH   ; 65535
1711  F465 D1                   POP   DE
1712  F466 E1                   POP   HL
1713  F467 C9                   RET
1714  F468 E5           SUB56:  PUSH  HL            ; [5]
1715  F469 21 FF FF             LD    HL,0FFFFH   ; 65535
1716  F46C 22 FA 8F     LBL125: LD    (bios_vars.inverse),HL
1717  F46F E1                   POP   HL
1718  F470 C9                   RET
1719  F471 E5           SUB57:  PUSH  HL            ; [6]
1720  F472 21 00 00             LD    HL,0000H
1721  F475 C3 6C F4             JP    LBL125
1722  F478
1723  F478              ;----------------------------------------------------------------------
1724  F478              ; Запрос имени файла в строке состояния
1725  F478
1726  F478              inputFileName:
1727  F478 CD 3D F6             CALL  SUB63
1728  F47B 11 0A F7             LD    DE,BUFFER1
1729  F47E 01 CB F5             LD    BC,inputBuf
1730  F481 CD 2D C4             CALL  bios_memcpy_bc_hl
1731  F484 21 F9 00             LD    HL,00F9H
1732  F487 22 FC 8F             LD    (bios_vars.cursorY),HL
1733  F48A 21 FF FF             LD    HL,0FFFFH
1734  F48D 22 FA 8F             LD    (bios_vars.inverse),HL
1735  F490 21 C6 F5             LD    HL,txtFile
1736  F493 CD 18 C8             CALL  bios_printString
1737  F496 CD 03 C8             CALL  bios_getch
1738  F499 21 F9 0F             LD    HL,0FF9H
1739  F49C 22 FC 8F             LD    (bios_vars.cursorY),HL
1740  F49F FE 0D                CP    0DH           ; 13
1741  F4A1 CA BE F4             JP    Z,LBL126
1742  F4A4 F5                   PUSH  AF
1743  F4A5 21 FE F5             LD    HL,txtSpace12
1744  F4A8 CD 18 C8             CALL  bios_printString
1745  F4AB 21 F9 0F             LD    HL,0FF9H
1746  F4AE 22 FC 8F             LD    (bios_vars.cursorY),HL
1747  F4B1 21 CB F5             LD    HL,inputBuf
1748  F4B4 01 CB F5             LD    BC,inputBuf
1749  F4B7 11 DB F5             LD    DE,inputBufEnd    ; 56781
1750  F4BA F1                   POP   AF
1751  F4BB C3 22 F5             JP    LBL131
1752  F4BE
1753  F4BE 21 CB F5     LBL126: LD    HL,inputBuf
1754  F4C1 11 DB F5             LD    DE,inputBufEnd
1755  F4C4 01 00 F7             LD    BC,BUFFER2
1756  F4C7 CD 2D C4             CALL  bios_memcpy_bc_hl
1757  F4CA 21 00 00             LD    HL,0000H
1758  F4CD 22 FA 8F             LD    (bios_vars.inverse),HL
1759  F4D0 C9                   RET
1760  F4D1
1761  F4D1              ;----------------------------------------------------------------------
1762  F4D1              ; Загрузка файла с диска
1763  F4D1
1764  F4D1              openFile:
1765  F4D1 CD E4 F4             CALL  prepareFileName
1766  F4D4 2A 06 E8             LD    HL,(VAR01)
1767  F4D7 EB                   EX    DE,HL
1768  F4D8 21 DE F5             LD    HL,fileDescName
1769  F4DB CD 66 C8             CALL  bios_fileLoad2
1770  F4DE DA 6D F5             JP    C,LBL135
1771  F4E1 C3 BE F4             JP    LBL126
1772  F4E4
1773  F4E4              ;----------------------------------------------------------------------
1774  F4E4              ; Подготовка имени файла для файловых операций
1775  F4E4
1776  F4E4              prepareFileName:
1777  F4E4 21 CB F5             LD    HL,inputBuf
1778  F4E7 11 DE F5             LD    DE,fileDescName
1779  F4EA CD 5A C8             CALL  bios_fileNamePrepare
1780  F4ED C9                   RET
1781  F4EE
1782  F4EE              ;----------------------------------------------------------------------
1783  F4EE              ; Сохранение файла на диск
1784  F4EE
1785  F4EE              saveFile:
1786  F4EE CD E4 F4             CALL  prepareFileName
1787  F4F1 11 00 00             LD    DE,0000H
1788  F4F4 06 00                LD    B,00H
1789  F4F6 2A 06 E8             LD    HL,(VAR01)
1790  F4F9
1791  F4F9              getCRC: ; Поиск конца буфера и подсчет контрольной суммы
1792  F4F9                  IF STANDARD_EDITOR
1793  F4F9 ~                    ; В MXOS 2 контрольная сумма не нужна
1794  F4F9 ~                    LD    A,B
1795  F4F9 ~                    ADD   A,(HL)
1796  F4F9 ~                    LD    B,A
1797  F4F9                  ENDIF
1798  F4F9 13                   INC   DE
1799  F4FA 7E                   LD    A,(HL)
1800  F4FB 3C                   INC   A
1801  F4FC CA 03 F5             JP    Z,LBL128
1802  F4FF 23                   INC   HL
1803  F500 C3 F9 F4             JP    getCRC
1804  F503
1805  F503                      ; Формирование дескриптора файла
1806  F503 2A 06 E8     LBL128: LD    HL,(VAR01)
1807  F506 22 F0 F5             LD    (fileDescAddr),HL
1808  F509 EB                   EX    DE,HL
1809  F50A 22 FA F5             LD    (fileDescSize),HL
1810  F50D
1811  F50D                  IF STANDARD_EDITOR
1812  F50D ~                    ; В MXOS 2 контрольная сумма не нужна
1813  F50D ~                    LD    A,B
1814  F50D ~                    LD    (fileDescCRC),A
1815  F50D                  ENDIF
1816  F50D
1817  F50D                      ; Сохранение файла
1818  F50D 21 DE F5             LD    HL,fileDescName
1819  F510 CD 45 C8             CALL  bios_fileCreate
1820  F513 DA 6D F5             JP    C,LBL135
1821  F516 C3 BE F4             JP    LBL126
1822  F519
1823  F519              ;----------------------------------------------------------------------
1824  F519
1825  F519 F1           LBL129: POP   AF
1826  F51A C3 18 EA             JP    SUB1
1827  F51D 44                   LD    B,H
1828  F51E 4D                   LD    C,L
1829  F51F CD 03 C8     LBL130: CALL  bios_getch          ; [4]
1830  F522 FE 08        LBL131: CP    08H           ; 8
1831  F524 CA 49 F5             JP    Z,LBL132
1832  F527 FE 0D                CP    0DH           ; 13
1833  F529 CA 68 F5             JP    Z,LBL134
1834  F52C FE 1F                CP    1FH           ; 31
1835  F52E CA BC F5             JP    Z,LBL140
1836  F531 FE 20                CP    20H           ; 32 ' '
1837  F533 DA 1F F5             JP    C,LBL130
1838  F536 F5                   PUSH  AF
1839  F537 CD 27 C4             CALL  bios_cmp_hl_de
1840  F53A CA 19 F5             JP    Z,LBL129
1841  F53D F1                   POP   AF
1842  F53E 77                   LD    (HL),A
1843  F53F C5                   PUSH  BC
1844  F540 4F                   LD    C,A
1845  F541 CD 09 C8             CALL  bios_printChar
1846  F544 C1                   POP   BC
1847  F545 23                   INC   HL
1848  F546 C3 1F F5             JP    LBL130
1849  F549 7C           LBL132: LD    A,H
1850  F54A B8                   CP    B
1851  F54B C2 53 F5             JP    NZ,LBL133
1852  F54E 7D                   LD    A,L
1853  F54F B9                   CP    C
1854  F550 CA 1F F5             JP    Z,LBL130
1855  F553 2B           LBL133: DEC   HL
1856  F554 C5                   PUSH  BC
1857  F555 0E 08                LD    C,08H         ; 8
1858  F557 CD 09 C8             CALL  bios_printChar
1859  F55A 0E 20                LD    C,20H         ; 32 ' '
1860  F55C CD 09 C8             CALL  bios_printChar
1861  F55F 0E 08                LD    C,08H         ; 8
1862  F561 CD 09 C8             CALL  bios_printChar
1863  F564 C1                   POP   BC
1864  F565 C3 1F F5             JP    LBL130
1865  F568 36 00        LBL134: LD    (HL),00H
1866  F56A C3 BE F4             JP    LBL126
1867  F56D 0E 05        LBL135:  LD    C,05H         ; 5; [5]
1868  F56F CD 70 C1     LBL136: CALL  bios_beep_Old
1869  F572 06 FF                LD    B,0FFH                ; 255
1870  F574 CD 90 C1             CALL  bios_delay_b
1871  F577 CD 90 C1             CALL  bios_delay_b
1872  F57A 0D                   DEC   C
1873  F57B C2 6F F5             JP    NZ,LBL136
1874  F57E C3 BE F4             JP    LBL126
1875  F581              ;----------------------------------------------------------------------
1876  F581
1877  F581              insertFile:
1878  F581 CD E4 F4             CALL  prepareFileName
1879  F584 21 DE F5             LD    HL,fileDescName
1880  F587
1881  F587                      ; Запрашиваем дескриптор файла
1882  F587 CD 51 C8             CALL  bios_fileLoadInfo
1883  F58A 2A FA F5             LD    HL,(fileDescSize)
1884  F58D EB                   EX    DE,HL         ; de = размер файла
1885  F58E D5                   PUSH  DE
1886  F58F 2A 06 E8             LD    HL,(VAR01)    ; hl = адрес буфера
1887  F592
1888  F592                      ; Сканируем буфер, пока не найдем конец текста (0FFh)
1889  F592 7E           LBL137: LD    A,(HL)
1890  F593 3C                   INC   A
1891  F594 CA 9B F5             JP    Z,LBL138
1892  F597 23                   INC   HL
1893  F598 C3 92 F5             JP    LBL137
1894  F59B
1895  F59B D1           LBL138: POP   DE    ; de = размер файла
1896  F59C E5                   PUSH  HL    ; hl = адрес конца буфера
1897  F59D 19                   ADD   HL,DE
1898  F59E EB                   EX    DE,HL
1899  F59F 2A 08 E8             LD    HL,(VAR03)
1900  F5A2 7C                   LD    A,H
1901  F5A3 BA                   CP    D
1902  F5A4 DA 6D F5             JP    C,LBL135
1903  F5A7 C2 AF F5             JP    NZ,LBL139
1904  F5AA 7D                   LD    A,L
1905  F5AB BB                   CP    E
1906  F5AC DA 6D F5             JP    C,LBL135
1907  F5AF
1908  F5AF                      ; загрузка файла по адресу de
1909  F5AF D1           LBL139: POP   DE
1910  F5B0 21 DE F5             LD    HL,fileDescName
1911  F5B3 CD 66 C8             CALL  bios_fileLoad2
1912  F5B6 DA 6D F5             JP    C,LBL135
1913  F5B9 C3 BE F4             JP    LBL126
1914  F5BC
1915  F5BC              ;----------------------------------------------------------------------
1916  F5BC
1917  F5BC D1           LBL140: POP   DE
1918  F5BD 21 00 00             LD    HL,0000H
1919  F5C0 22 FA 8F             LD    (bios_vars.inverse),HL
1920  F5C3 C3 1C E9             JP    LBL10
1921  F5C6
1922  F5C6              ;----------------------------------------------------------------------
1923  F5C6
1924  F5C6 46 49 4C 45  txtFile:        DB    "FILE:"
1924  F5CA 3A
1925  F5CB
1926  F5CB                  IF STANDARD_EDITOR
1927  F5CB ~
1928  F5CB ~            inputBuf:       BLOCK 10, 00h
1929  F5CB ~            inputBufEnd:    DB    00H,00H,00H
1930  F5CB ~
1931  F5CB ~            ; Дескриптор файла (запись в каталоге MXOS FAT8)
1932  F5CB ~            fileDescName:   BLOCK 10, 20h   ; имя, расширение и атрибуты
1933  F5CB ~            fileDescAddr:   DW    2020H     ; адрес загрузки
1934  F5CB ~            fileDescSize:   DW    2020H     ; размер
1935  F5CB ~            fileDescCRC:    DB    20H       ; контрольная сумма
1936  F5CB ~                            DB    20H       ; первый сектор
1937  F5CB ~
1938  F5CB                  ELSE
1939  F5CB
1940  F5CB 00 00 00...  inputBuf:       BLOCK 16, 00h
1941  F5DB 00 00 00     inputBufEnd:    DB    00H,00H,00H
1942  F5DE
1943  F5DE              ; Дескриптор файла (запись в каталоге FAT16)
1944  F5DE 20 20 20...  fileDescName:   BLOCK 12, 20h   ; имя, расширение и атрибуты
1945  F5EA 00 00 00...                  BLOCK 6, 0
1946  F5F0 20 20        fileDescAddr:   DW    2020H     ; адрес загрузки
1947  F5F2 00 00 00...                  BLOCK 8, 0
1948  F5FA 20 20        fileDescSize:   DW    2020H     ; размер
1949  F5FC 00 00                        BLOCK 2, 0
1950  F5FE
1951  F5FE                  ENDIF
1952  F5FE
1953  F5FE 20 20 20 20  txtSpace12:     DB   "            ",00H
1953  F602 20 20 20 20
1953  F606 20 20 20 20
1953  F60A 00
1954  F60B
1955  F60B              ;----------------------------------------------------------------------
1956  F60B
1957  F60B                      ; Обработка кода нажатой клавиши
1958  F60B              keyInput:
1959  F60B CD 03 C8             CALL  bios_getch
1960  F60E 4F                   LD    C,A
1961  F60F FE 03                CP    03H               ; F4 - открыть файл
1962  F611 CA 21 F6             JP    Z,keyHandler_F4
1963  F614 FE 04                CP    04H               ; F5 - сохранить файл на диск
1964  F616 CA 2A F6             JP    Z,keyHandler_F5
1965  F619 FE 05                CP    05H               ; F6 - открыть файл и вставить его в конец документа
1966  F61B CA 33 F6             JP    Z,keyHandler_F6
1967  F61E C3 57 E9             JP    keyInput2
1968  F621
1969  F621              ;----------------------------------------------------------------------
1970  F621
1971  F621              keyHandler_F4:
1972  F621 CD 78 F4             CALL  inputFileName
1973  F624 CD D1 F4             CALL  openFile
1974  F627 C3 10 E8             JP    LBL3
1975  F62A
1976  F62A              keyHandler_F5:
1977  F62A CD 78 F4             CALL  inputFileName
1978  F62D CD EE F4             CALL  saveFile
1979  F630 C3 18 EA             JP    SUB1
1980  F633
1981  F633              keyHandler_F6:
1982  F633 CD 78 F4             CALL  inputFileName
1983  F636 CD 81 F5             CALL  insertFile
1984  F639 C3 10 E8             JP    LBL3
1985  F63C
1986  F63C              ;----------------------------------------------------------------------
1987  F63C
1988  F63C                      ; ???
1989  F63C 00                   NOP
1990  F63D
1991  F63D              SUB63:
1992  F63D CD 26 EC             CALL  SUB15
1993  F640 21 00 F7             LD    HL,BUFFER2
1994  F643 C9                   RET
1995  F644              LBL145:
1996  F644 EB                   EX    DE,HL
1997  F645 11 5A F6             LD    DE,REF29
1998  F648 CD 5A C8             CALL  bios_fileNamePrepare
1999  F64B 2A 06 E8             LD    HL,(VAR01)
2000  F64E EB                   EX    DE,HL
2001  F64F 21 5A F6             LD    HL,REF29
2002  F652 CD 66 C8             CALL  bios_fileLoad2
2003  F655 C3 0A E8             JP    LBL2
2004  F658
2005  F658 00 00                DB    00H,00H
2006  F65A 00 00 00 00  REF29:  DB    00H,00H,00H,00H
2007  F65E
