;+---------------------------------------------------------------------------
; MXOS
; Сохранить FAT и корневой каталог на устройство
;
; На выходе
;  регистры bc, de, hl сохраняются
;
; 2013-12-12 Дизассемблировано vinxru
;----------------------------------------------------------------------------

saveFatDir: ; Сохраняем регистры
            push    de

            ; Режим - запись
            ld      e, 1  

            ; Переход к общему коду             
            jp      loadFatDir_0

;----------------------------------------------------------------------------
; Загрузить FAT и корневой каталог с устройства
;
; На выходе
;  регистры bc, de, hl сохраняются
;----------------------------------------------------------------------------

loadFatDir: ; Сохраняем регистры
            push    de

            ; Режим - чтение
            ld      e, 2

loadFatDir_0:
            ; Сохраняем регистры
            push    hl

            ; Чтение/запись 1024 байт с начала диска в FB00h задом наперед
            ld      hl, diskDirectoryEnd
            ld      d, 3        ; Сектор

loadFatDir_1:
            call    j_diskDriver
            dec     h
            dec     d
            jp p,   loadFatDir_1

            ; Восстанавливаем регистры и выходим
            pop     hl
            pop     de
            ret

