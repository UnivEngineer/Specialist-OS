  1   0000              ;----------------------------------------------------------------------------
  2   0000              ; РљСЂРѕСЃСЃ-РїР»Р°С‚С„РѕСЂРјРµРЅРЅС‹Р№ С‚РµСЃС‚ СЌРєСЂР°РЅР° РґР»СЏ "РЎРїРµС†РёР°Р»РёСЃС‚Р°-MX"
  3   0000              ; Р”РѕР»Р¶РµРЅ СЂР°Р±РѕС‚Р°С‚СЊ РІ Р»СЋР±РѕР№ OC
  4   0000              ;
  5   0000              ; 2022-02-05 SpaceEnigneer
  6   0000              ;----------------------------------------------------------------------------
  7   0000
  8   0000                  INCLUDE "../include/mxos.inc"
  1+  0000              ;-----------------------------------------------------------------------
  2+  0000              ; MXOS
  3+  0000              ; Точки входа и настройки сборки MXOS
  4+  0000              ;
  5+  0000              ; Новая карта памяти:
  6+  0000              ;   8FDF-8FFF - [  32 B] Переменные
  7+  0000              ;   9000-BFFF - [12  KB] Экран
  8+  0000              ;   C000-D3FF - [5120 B] DOS.SYS
  9+  0000              ;   D400-DBFF - [2048 B] Свободно (2048 байт)
 10+  0000              ;   DC00-EDFF - [ 512 B] Драйвер магнитофона
 11+  0000              ;   DE00-DFFF - [ 512 B] Драйвер флеш-диска
 12+  0000              ;   E000-E7FF - [2048 B] Шрифт
 13+  0000              ;   E800-FAFF - [4864 B] Системные программы (NC.COM, E.COM, DL-RED.COM, FORMAT.COM, MON2.COM, ...)
 14+  0000              ;   FB00-FEFF - [1024 B] Дисковый кэш (fat + каталог)
 15+  0000              ;   FF00-FF81 - [ 130 B] Командная строка
 16+  0000              ;   FF82-FFBF - [  62 B] Стек
 17+  0000              ;   FFC0-FFEF - [  32 B] Непереключаемое ОЗУ, драйвер обмена с RAM диском
 18+  0000              ;   FFE0-FFFF - [  32 B] Оборудование
 19+  0000              ;
 20+  0000              ; Старая карта памяти:
 21+  0000              ;   8FDF-8FFF - [  32 B] Переменные
 22+  0000              ;   9000-BFFF - [12  KB] Экран
 23+  0000              ;   C000-CFFF - [4096 B] DOS.SYS
 24+  0000              ;   D000-E1FF - [4607 B] Системные программы (NC.COM, E.COM, DL-RED.COM)
 25+  0000              ;   E200-E5FF - [1024 B] Свободно (1024 байт)
 26+  0000              ;   E600-E7FF - [ 512 B] Драйвер магнитофона
 27+  0000              ;   E800-E8FF - [ 256 B] Свободно (256 байт)
 28+  0000              ;   E900-F0FF - [2048 B] Шрифт (можно отключить запуском ROMFNT.COM или опцией LOAD_FONT=0)
 29+  0000              ;   F100-F8FF - [2048 B] Системные программы (FORMAT.COM, MON2.COM, ...)
 30+  0000              ;   F900-F9FF - [ 256 B] Свободно (256 байт)
 31+  0000              ;   FA00-FAFF - [ 256 B] Драйвер флеш-диска
 32+  0000              ;   FB00-FEFF - [1024 B] Дисковый буфер (fat + каталог)
 33+  0000              ;   FF00-FF81 - [ 130 B] Командная строка
 34+  0000              ;   FF82-FFBF - [  62 B] Стек
 35+  0000              ;   FFC0-FFEF - [  32 B] Непереключаемое ОЗУ, драйвер обмена с RAM диском
 36+  0000              ;   FFE0-FFFF - [  32 B] Оборудование
 37+  0000              ;-----------------------------------------------------------------------
 38+  0000
 39+  0000
 40+  0000              ;-----------------------------------------------------------------------
 41+  0000              ; Конфигурация сборки
 42+  0000              ;-----------------------------------------------------------------------
 43+  0000
 44+  0000              NEW_MEMORY_MAP       =  1       ; Новая карта памяти
 45+  0000              RAMD_MAX_PAGE        =  16      ; Максимальное количество страниц RAM диска
 46+  0000              RAMD_PAGE_END        =  0FFBBh  ; Включить поддержку ДОЗУ большего чем 64 Кб
 47+  0000              ROM_64K              =  1       ; Включить поддержку ПЗУ 64 Кб Специалиста МХ2
 48+  0000              ENABLE_COLOR         =  1       ; Включить поддержку цвета
 49+  0000              EMBED_FONT           =  0       ; Встроить шрифт в программу (при запуске шрифт копируется на FONT_ADDR)
 50+  0000              LOAD_FONT            =  1       ; Загружать шрифт в ОЗУ
 51+  0000              COLOR_BIOS           =  0F0h    ; Цвет командной строки
 52+  0000              RAMFOS_COMPATIBILITY =  1       ; Совместимость с RAMFOS (WIP)
 53+  0000              BOOT_FROM_TAPE       =  0       ; Включить загрузку с ленты при нажатой клавише после сброса
 54+  0000
 55+  0000                  IF  NEW_MEMORY_MAP
 56+  0000              FONT_ADDR = 0E000h  ; Адрес шрфита
 57+  0000                  ELSE
 58+  0000 ~            FONT_ADDR = 0E900h  ; Адрес шрфита
 59+  0000                  ENDIF
 60+  0000
 61+  0000                  IF  LOAD_FONT
 62+  0000              FONT_ADDR_DIV_8 = FONT_ADDR/8
 63+  0000                  ELSE
 64+  0000 ~            FONT_ADDR_DIV_8 = -1
 65+  0000                  ENDIF
 66+  0000
 67+  0000              ;-----------------------------------------------------------------------
 68+  0000              ; Переменные ОС в подэкранном пространстве и их начальные значения
 69+  0000              ; Доступ к переменным из программ польователя:
 70+  0000              ; ld a, bios_vars.lastKey
 71+  0000              ;-----------------------------------------------------------------------
 72+  0000
 73+  0000                  STRUCT BIOS_VARIABLES
 74+  0000 ~            _reserv_1     DW      -1              ; 8FDFh -
 75+  0000 ~            tapeError     DW      0C800h          ; 8FE1h - Адрес, куда происходит переход при ошибке чтения с ленты
 76+  0000 ~            tapeAddr      DW      -1              ; 8FE3h - Адрес программы загруженной с ленты
 77+  0000 ~            _reserv_2     DW      -1              ; 8FE5h -
 78+  0000 ~            charGen       DW      FONT_ADDR_DIV_8 ; 8FE7h - Адрес альтернативного знакогенератора / 8
 79+  0000 ~            cursorCfg     DB       21h ; 0A9h     ; 8FE9h - Внешний вид курсора (биты: 7 - мигание (если 0), 654 - положение (Y) от низа строки, 3210 - размер по высоте)
 80+  0000 ~            koi7          DB       0   ; 0FFh     ; 8FEAh - 0FFh = включен KOI-7, 0 = включен KOI-8
 81+  0000 ~            escMode       DB      -1              ; 8FEBh - Обработка ESC-последовательности
 82+  0000 ~            keyLocks      DB      0BAh ; 3Ah      ; 8FECh - Caps Lock или Рус/Lat (3A - прописные анг, BA - строчные анг, BB - прописные рус, 3B - строчные рус)
 83+  0000 ~            _reserv_3     DW      -1              ; 8FEDh -
 84+  0000 ~            lastLastKey   DB      -1              ; 8FEFh - Предпоследняя нажатая клавиша
 85+  0000 ~            lastKey       DB      -1              ; 8FF0h - Последняя нажатая клавиша
 86+  0000 ~            beepFreq      DB       5Fh            ; 8FF1h - Частота звукового сигнала (также влияет на длительность)
 87+  0000 ~            beepDuration  DB       20h            ; 8FF2h - Длительность звукового сигнала (сколько раз повторять посылку)
 88+  0000 ~            tapeInverse   DB      0FFh            ; 8FF3h - Признак инверсии данных с ленты
 89+  0000 ~            cursorDelay   DB       20h            ; 8FF4h - Задержка мигания курсора
 90+  0000 ~            antiBsDelay   DB      0E0h            ; 8FF5h - Задержка защиты от дребезга контактов клавиш
 91+  0000 ~            oldSP         DW      -1              ; 8FF6h - Используется для сохранения SP некоторыми функциями
 92+  0000 ~            ramPageCount  DB      RAMD_MAX_PAGE   ; 8FF8h - Количество детектированных 64кб страниц RAM-диска
 93+  0000 ~            _reserv_4     DB       0              ; 8FF9h -
 94+  0000 ~            inverse       DW       0              ; 8FFAh - Инвертирование текста (0=нормальный текст, 0FFFFh=инверсный)
 95+  0000 ~            cursorY       DB      -1              ; 8FFCh - Положение курсора по вертикали в пикселях
 96+  0000 ~            cursorX       DB      -1              ; 8FFDh - Положение курсора по горизонтали в пикселях / 2
 97+  0000 ~            writeDelay    DB      28h             ; 8FFEh - Скорость при записи на ленту
 98+  0000 ~            readDelay     DB      3Ch             ; 8FFFh - Скорость при чтении с ленты
 99+  0000                  ENDS
100+  0000
101+  0000              ; Блок переменных BIOS начинается с адреса 8FDFh
102+  0000              bios_vars   BIOS_VARIABLES = 8FDFh
103+  0000
104+  0000              ;-----------------------------------------------------------------------
105+  0000              ; Стандартные точки входа ОС
106+  0000              ; Отмеченные [OLD] применять не рекомендуется
107+  0000              ; Отмеченные [MXOS2] - новые в MXOS 2
108+  0000              ;-----------------------------------------------------------------------
109+  0000
110+  0000              bios_init               = 0C000h ; Теплая перезагрузка
111+  0000
112+  0000              ; Устаревшие точки, лечше не применять
113+  0000              bios_keyScanOld         = 0C003h ; [OLD] Получить код нажатой клавиши, = bios_keyScan
114+  0000              bios_drawCursorOld      = 0C006h ; [OLD] Нарисовать/стереть курсор
115+  0000              bios_clearScreenOld     = 0C010h ; [OLD] Оистка экрана
116+  0000              bios_printCharOld       = 0C037h ; [OLD] Вывод символа на экран
117+  0000              bios_beep_Old           = 0C170h ; [OLD] Звуковой сигнал
118+  0000              bios_delay_l            = 0C18Fh ; [OLD] Задержка l циклов
119+  0000              bios_delay_b            = 0C190h ; [OLD] Задержка b циклов
120+  0000              bios_getchOld           = 0C337h ; [OLD] Ожидание ввода с клавиатуры
121+  0000              bios_tapeReadOld        = 0C377h ; [OLD] Чтение байта с магнитофона
122+  0000              bios_tapeWriteOld       = 0C3D0h ; [OLD] Запись байта на магнитофон
123+  0000              bios_cmp_hl_de          = 0C427h ; [OLD] Сравнить hl и de
124+  0000              bios_memcpy_bc_hl       = 0C42Dh ; [OLD] Скопировать блок памяти
125+  0000              bios_printStringOld     = 0C438h ; [OLD] Вывод строки на экран
126+  0000
127+  0000              ; Стандартные точки C800h
128+  0000              bios_reboot             = 0C800h ; Запустить NC.COM
129+  0000              bios_getch              = 0C803h ; Ожидание ввода с клавиатуры
130+  0000              bios_tapeRead           = 0C806h ; Чтение байта с магнитофона
131+  0000              bios_printChar          = 0C809h ; Вывод символа на экран
132+  0000              bios_tapeWrite          = 0C80Ch ; Запись байта на магнитофон
133+  0000              bios_input              = 0C80Fh ; Ввод строки с клавиатуры
134+  0000              bios_keyCheck           = 0C812h ; Получить код нажатой клавиши, = bios_keyScan
135+  0000              bios_printHexByte       = 0C815h ; Вывод HEX числа на экран (байт)
136+  0000              bios_printString        = 0C818h ; Вывод строки на экран
137+  0000              bios_keyScan            = 0C81Bh ; Получить код нажатой клавиши
138+  0000              bios_getCursorPos       = 0C81Eh ; Получить координаты курсора в hl (координаты в пикселях)
139+  0000              bios_setCursorPos       = 0C821h ; Установить координаты курсора из hl (координаты в пикселях)
140+  0000              bios_tapeLoad           = 0C824h ; Загрузить программу с магнитофона
141+  0000              bios_tapeSave           = 0C827h ; Сохранить программу на магнитофон
142+  0000              bios_calcCS             = 0C82Ah ; Расчет контрольной суммы
143+  0000              bios_printHexWord       = 0C82Dh ; Вывод HEX числа на экран (слово)
144+  0000              bios_getMemTop          = 0C830h ; Получить объем доступной памяти
145+  0000              bios_setMemTop          = 0C833h ; Установить объем доступной памяти
146+  0000              bios_printer            = 0C836h ; Напечатать байт на принтере
147+  0000                  IF RAMFOS_COMPATIBILITY
148+  0000              bios_strToHex           = 0C839h ; [MXOS2] Преобразвоние строки в HEX формате в число
149+  0000                  ELSE
150+  0000 ~            bios_rebootAlt          = 0C839h ; Запустить NC.COM
151+  0000                  ENDIF
152+  0000              bios_rebootAlt2         = 0C83Ch ; Запустить NC.COM
153+  0000              bios_fileList           = 0C83Fh ; Получить список файлов
154+  0000              bios_fileGetSetDrive    = 0C842h ; Получить/установить активное устройство
155+  0000              bios_fileCreate         = 0C845h ; Создать файл
156+  0000              bios_fileLoad           = 0C848h ; Загрузить файл по адресу из заголовка этого файла
157+  0000              bios_fileDelete         = 0C84Bh ; Удалить файл
158+  0000              bios_fileRename         = 0C84Eh ; Переименовать файл
159+  0000              bios_fileLoadInfo       = 0C851h ; Загрузить информацию о файле
160+  0000              bios_fileGetSetAddr     = 0C854h ; Получить/установить адрес загрузки файла
161+  0000              bios_fileGetSetAttr     = 0C857h ; Получить/установить атрибуты файла
162+  0000              bios_fileNamePrepare    = 0C85Ah ; Преобразовать имя файла во внутренний формат
163+  0000              bios_fileExec           = 0C85Dh ; Запустить файл
164+  0000              bios_installDriver      = 0C860h ; Установить драйвер накопителя
165+  0000              bios_diskDriver         = 0C863h ; Драйвер выбранного диска
166+  0000              bios_fileLoad2          = 0C866h ; Загрузить файл по адресу de
167+  0000
168+  0000              ; Новые точки C800h MXOS2
169+  0000              bios_printCharReal      = 0C869h ; [MXOS2] Вывод символа на экран (только реальные символы)
170+  0000              bios_printDecWord       = 0C86Ch ; [MXOS2] Вывод числа экран в десятичной форме
171+  0000              bios_setRAMDDriver      = 0C86Fh ; [MXOS2] Установить драйвр рам-диска
172+  0000              bios_getDriveFreeSpace  = 0C872h ; [MXOS2] Получить оставшийся свободный объем диска
173+  0000              bios_upperCase          = 0C875h ; [MXOS2] Перевод кода символа КОИ-8 в верхний регистр
174+  0000              bios_strcmp             = 0C878h ; [MXOS2] Сравнение строк, чувствительное к регистру
175+  0000              bios_stricmp            = 0C87Bh ; [MXOS2] Сравнение строк, нечувствительное к регистру
176+  0000              bios_sub_hl_de          = 0C87Eh ; [MXOS2] Вычитание hl и de: hl = hl - de
177+  0000              bios_div_hl_2           = 0C881h ; [MXOS2] Деление hl на 2: hl = hl / 2
178+  0000              bios_mul_hl_de          = 0C884h ; [MXOS2] Умножение hl на de: hl = hl * de
179+  0000              bios_div_hl_de          = 0C887h ; [MXOS2] Деление hl на de: hl = hl / de, de = hl % de
180+  0000
181+  0000              ;-----------------------------------------------------------------------
182+  0000              ; Адрес таблицы переходов драйвера магнитофона
183+  0000              ;-----------------------------------------------------------------------
184+  0000
185+  0000              TAPE_DRIVER_JUMPS = bios_tapeReadOld    ; размещается на месте бывшей п/п чтения байта
186+  0000
187+  0000              ;-----------------------------------------------------------------------
188+  0000              ; Непереключаемое ОЗУ ПК "Специалист-MX" (0FFC0h-0FFDF, 32 байта)
189+  0000              ;-----------------------------------------------------------------------
190+  0000
191+  0000              bios_RAMDRead   = 0FFC0h ; п/п чтения из ДОЗУ
192+  0000              bios_RAMDWrite  = 0FFD0h ; п/п записи в  ДОЗУ
193+  0000
194+  0000              ;-----------------------------------------------------------------------
195+  0000              ; Порты устройств ПК "Специалист-MX2" (0FFE0h-0FFFF, 32 байта)
196+  0000              ;-----------------------------------------------------------------------
197+  0000
198+  0000              IO_KEYB_A       =  0FFE0h   ; ВВ55 клавиатуры
199+  0000              IO_KEYB_B       =  0FFE1h
200+  0000              IO_KEYB_C       =  0FFE2h
201+  0000              IO_KEYB_MODE    =  0FFE3h
202+  0000              IO_PROG_A       =  0FFE4h   ; ВВ55 программатора/флеш диска
203+  0000              IO_PROG_B       =  0FFE5h
204+  0000              IO_PROG_C       =  0FFE6h
205+  0000              IO_PROG_MODE    =  0FFE7h
206+  0000              IO_FDD_CMD      =  0FFE8h   ; контроллер дисковода ВГ93
207+  0000              IO_FDD_TRACK    =  0FFE9h
208+  0000              IO_FDD_SECTOR   =  0FFEAh
209+  0000              IO_FDD_DATA     =  0FFEBh
210+  0000              IO_TIMER_CH0    =  0FFECh   ; таймер ВИ53
211+  0000              IO_TIMER_CH1    =  0FFEDh
212+  0000              IO_TIMER_CH2    =  0FFEEh
213+  0000              IO_TIMER_MODE   =  0FFEFh
214+  0000              IO_FDD_REQ      =  0FFF0h   ; контроллер дисковода
215+  0000              IO_FDD_MOTOR    =  0FFF1h
216+  0000              IO_FDD_SIDE     =  0FFF2h
217+  0000              IO_FDD_DRIVE    =  0FFF3h
218+  0000              IO_COLOR        =  0FFF8h   ; регистр цвета
219+  0000              IO_PAGE_RAM     =  0FFFCh   ; порт включения основного ОЗУ
220+  0000              IO_PAGE_RAMD    =  0FFFDh   ; порт включения ОЗУ RAM-дисков
221+  0000              IO_PAGE_ROM     =  0FFFEh   ; порт включения ПЗУ
222+  0000              IO_PAGE_STD     =  0FFFFh   ; порт включения STD режима
223+  0000
224+  0000              ;-----------------------------------------------------------------------
225+  0000              ; Структура файловой системы
226+  0000              ;-----------------------------------------------------------------------
227+  0000
228+  0000              ; Структура каталога
229+  0000              FILE_DESCR_SIZE  = 32   ; размер дескриптора файла в каталоге (байт)
230+  0000              FILE_NAME_LENGTH = 8    ; длина имени файла  (байт)
231+  0000              FAT_ITEM_SIZE    = 2    ; размер записи в таблице FAT (байт)
232+  0000
233+  0000              SECTOR_SIZE  = 00100h   ; размер сектора 256 байт
234+  0000              CLUSTER_SIZE = 00100h   ; размер кластера 256 байт
235+  0000
236+  0000              ; Специальные коды кластеров FAT
237+  0000              FAT12_BAD = 00FF7h  ; плохой кластер
238+  0000              FAT16_BAD = 0FFF7h
239+  0000              FAT12_EOC = 00FFFh  ; последний кластер файла
240+  0000              FAT16_EOC = 0FFFFh
241+  0000              FAT12_RES = 00FFFh  ; зарезервированный кластер
242+  0000              FAT16_RES = 0FFFFh
243+  0000
244+  0000              ;-----------------------------------------------------------------------
245+  0000              ; Десткриптор файла (одна запись в каталоге) FAT12/16/32
246+  0000              ;-----------------------------------------------------------------------
247+  0000
248+  0000                  STRUCT FILE_DESCRIPTOR  ; 32 байта
249+  0000 ~            name            BLOCK   FILE_NAME_LENGTH    ; смещение 00h, 8 байт  - имя файла
250+  0000 ~            ext             BLOCK   3                   ; смещение 08h, 3 байта - расширение имени файла
251+  0000 ~            attrib          BLOCK   1                   ; смещение 0Bh, 1 байт  - атрибуты файла
252+  0000 ~            ntReserved      BLOCK   1                   ; смещение 0Ch, 1 байт  - используются в Windows NT
253+  0000 ~            createTimeTenth BLOCK   1                   ; смещение 0Dh, 1 байт  - (только FAT32) время создания файла, десятки миллисекунд (0-199)
254+  0000 ~            createTime      BLOCK   2                   ; смещение 0Eh, 2 байта - (только FAT32) время создания файла, секунды*2 (0-43200)
255+  0000 ~            createDate      BLOCK   2                   ; смещение 10h, 2 байта - (только FAT32) дата  создания файла
256+  0000 ~            loadAddress     BLOCK   2  ; accDate        ; смещение 12h, 2 байта - начальный адрес загрузки в ОЗУ, он же и стартовый (!!! временный костыль, в FAT32 это accDate - дата доступа к файлу !!!)
257+  0000 ~            firstClusterHi  BLOCK   2                   ; смещение 14h, 2 байта - номер первого кластера в FAT, старшее слово
258+  0000 ~            writeTime       BLOCK   2                   ; смещение 16h, 2 байта - время модификации файла, секунды*2 (0-43200)
259+  0000 ~            writeDate       BLOCK   2                   ; смещение 18h, 2 байта - дата  модификации файла
260+  0000 ~            firstCluster    BLOCK   2                   ; смещение 1Ah, 2 байта - номер первого кластера в FAT, младшее слово
261+  0000 ~            size            BLOCK   4                   ; смещение 1Ch, 4 байта - размер файла в байтах
262+  0000                  ENDS
263+  0000
264+  0000              ;-----------------------------------------------------------------------
265+  0000              ; Информация о файле (компактный вариант дескриптора)
266+  0000              ; Почти совместимо с дескриптором оригинального Коммандера
267+  0000              ;-----------------------------------------------------------------------
268+  0000
269+  0000              FILE_INFO_SIZE = 16     ; размер структуры (байт)
270+  0000
271+  0000                  STRUCT FILE_INFO    ; 16 байт
272+  0000 ~            name            BLOCK   FILE_NAME_LENGTH    ; смещение 00h, 8 байт  - имя файла
273+  0000 ~            ext             BLOCK   3                   ; смещение 08h, 3 байта - расширение имени файла
274+  0000 ~            attrib          BLOCK   1                   ; смещение 0Bh, 1 байт  - атрибуты файла
275+  0000 ~            loadAddress     BLOCK   2                   ; смещение 0Eh, 2 байта - начальный адрес загрузки в ОЗУ, он же и стартовый
276+  0000 ~            size            BLOCK   2                   ; смещение 0Ch, 2 байта - размер файла в байтах
277+  0000                  ENDS
278+  0000
279+  0000              ;-----------------------------------------------------------------------
280+  0000              ; Информация о активном накопителе (диске)
281+  0000              ;-----------------------------------------------------------------------
282+  0000
283+  0000                  STRUCT DISK_INFO
284+  0000 ~            sectorSize          BLOCK   2   ; размер сектора, байт (256, 512, 1024)
285+  0000 ~            sectorsPerCluster   BLOCK   2   ; размер кластера, секторов (1, 2, 4, 8)
286+  0000 ~            resSectors          BLOCK   2   ; сколько секторов занимает зарезервированная область = первый сектор таблицы fat
287+  0000 ~            fatSectors          BLOCK   2   ; сколько секторов занимает таблица fat
288+  0000 ~            dirSectors          BLOCK   2   ; сколько секторов занимает корневой каталог
289+  0000 ~            totalSectors        BLOCK   2   ; сколько всего секторов на диске
290+  0000 ~            rootDirMaxFiles     BLOCK   2   ; максимум файлов в корневом каталоге
291+  0000 ~            descrPerSector      BLOCK   2   ; сколько дескрипторов файлов вмещается в один сектор
292+  0000 ~            fatNumCells         BLOCK   2   ; количество ячеек в таблице fat (= fatSectors * sectorSize / 2)
293+  0000 ~            dirStartSector      BLOCK   2   ; первый сектор корневого каталога
294+  0000 ~            dataStartSector     BLOCK   2   ; первый сектор области данных
295+  0000 ~            volumeLabel         BLOCK  12   ; метка тома и 0 в конце
296+  0000 ~            isValid             BLOCK   1   ; 0 = нет драйвера, 1 = диск не распознан, 2 = диск распознан, корректно отформатирован
297+  0000                  ENDS
298+  0000
299+  0000              DISK_NO_DRIVER = 0
300+  0000              DISK_INVALID   = 1
301+  0000              DISK_VALID     = 2
302+  0000
303+  0000              ;-----------------------------------------------------------------------
304+  0000              ; Буферы в памяти
305+  0000              ;-----------------------------------------------------------------------
306+  0000
307+  0000              ; Дисковый кэш
308+  0000              FAT_CACHE_ADDR = 0FB00h ; адрес кэша секторов fat в памяти
309+  0000              FAT_CACHE_SIZE = 1024   ; размер кэша в байтах
310+  0000              FAT_CACHE_CAPACITY = FAT_CACHE_SIZE / SECTOR_SIZE   ; сколько секторов вмещается в кэш
311+  0000
312+  0000              ; Буфер для загрузки BAT файла
313+  0000                  IF NEW_MEMORY_MAP
314+  0000              BAT_BUFFER = 0E800h
315+  0000                  ELSE
316+  0000 ~            BAT_BUFFER = 0FC00h
317+  0000                  ENDIF
318+  0000
319+  0000              ; Командная строка и стек
320+  0000              CMD_LINE   = 0FF00h  ; 192 байта, но в конце стек
321+  0000              STACK_ADDR = 0FFC0h  ; стек
322+  0000
323+  0000              ;-----------------------------------------------------------------------
324+  0000              ; Всякие полезности
325+  0000              ;-----------------------------------------------------------------------
326+  0000
327+  0000              ; Макрос для заполнения памяти от текущего адреса до указанного
328+  0000                  MACRO ORG_PAD adr
329+  0000 ~                     IF $ > adr
330+  0000 ~                       ; вывод сообщения об ошибке
331+  0000 ~                       ASSERT 0
332+  0000 ~                       DISPLAY /l, "Error! ORG_PAD failed! ", $, " is more than ", adr
333+  0000 ~                     ELSE
334+  0000 ~                       ; заполнение памяти
335+  0000 ~                       BLOCK adr-$, 0FFh
336+  0000 ~                     ENDIF
337+  0000 ~                     ORG adr
338+  0000                  ENDM
339+  0000
340+  0000                  MACRO ORG_PAD0 adr
341+  0000 ~                     IF $ > adr
342+  0000 ~                       ; вывод сообщения об ошибке
343+  0000 ~                       ASSERT 0
344+  0000 ~                       DISPLAY /l, "Error! ORG_PAD0 failed! ", $, " is more than ", adr
345+  0000 ~                     ELSE
346+  0000 ~                       ; заполнение памяти
347+  0000 ~                       BLOCK adr-$, 0
348+  0000 ~                     ENDIF
349+  0000 ~                     ORG adr
350+  0000                  ENDM
351+  0000
352+  0000              ; Макросы для проверки текущего адреса
353+  0000                  MACRO ASSERT_EQUAL adr
354+  0000 ~                     IF $ != adr
355+  0000 ~                       ASSERT 0
356+  0000 ~                       DISPLAY /l, "Error! Entry point has been shifted (", $, " != ", adr, ")"
357+  0000 ~                     ENDIF
358+  0000                  ENDM
359+  0000
360+  0000                  MACRO ASSERT_DONT_FIT adr
361+  0000 ~                     IF $ > adr
362+  0000 ~                       ASSERT 0
363+  0000 ~                       DISPLAY /l, "Error! Image did not fit (", $, " > ", adr, ")"
364+  0000 ~                     ENDIF
365+  0000                  ENDM
366+  0000
367+  0000              ;-----------------------------------------------------------------------
368+  0000              ; Конец
369+  0000              ;-----------------------------------------------------------------------
370+  0000
  9   0000
 10   0000                  ORG 0
 11   0000
 12   0000              KOI8 = 1	; РїРµС‡Р°С‚СЊ СЃРёРјРІРѕР»РѕРІ РљРћР8 РІ С‚РµСЃС‚Рµ
 13   0000
 14   0000              ;-----------------------------------------------------
 15   0000
 16   0000              TestLoop:
 17   0000 3A 11 01         ld   a, (Mode)
 18   0003 FE 00            cp   0
 19   0005 CC 70 00         call z, TestCheckerboard
 20   0008                  ;cp   1
 21   0008                  ;call z, TestPrint
 22   0008 CD 7F 00         call TestPrint
 23   000B
 24   000B              KeyLoop:	; РћР¶РёРґР°РЅРёРµ РЅР°Р¶Р°С‚РёСЏ РєР»Р°РІРёС€Рё
 25   000B CD 1B C8     	call bios_keyScan
 26   000E FE 19        	cp   19h	; РєРЅРѕРїРєР° РІРІРµСЂС…
 27   0010 CA 30 00     	jp   z, ButUp
 28   0013 FE 1A        	cp   1Ah	; РєРЅРѕРїРєР° РІРЅРёР·
 29   0015 CA 3C 00     	jp   z, ButDown
 30   0018 FE 18        	cp   18h	; РєРЅРѕРїРєР° РІРїСЂР°РІРѕ
 31   001A CA 48 00     	jp   z, ButRight
 32   001D FE 08        	cp   08h	; РєРЅРѕРїРєР° РІР»РµРІРѕ
 33   001F CA 54 00     	jp   z, ButLeft
 34   0022 FE 20        	cp   20h	; РєРЅРѕРїРєР° РїСЂРѕР±РµР»
 35   0024 CA 60 00     	jp   z, ChangeMode
 36   0027 FE 1B        	cp   1Bh	; РєРЅРѕРїРєР° Esc
 37   0029 C8           	ret  z
 38   002A FE 1F        	cp   1Fh	; РєРЅРѕРїРєР° РЎРўР 
 39   002C C8           	ret  z
 40   002D C3 0B 00     	jp   KeyLoop
 41   0030
 42   0030              ;-----------------------------------------------------
 43   0030
 44   0030              ButUp:		; РЈРІРµР»РёС‡РёС‚СЊ С†РІРµС‚ СЃРёРјРІРѕР»РѕРІ
 45   0030 3A 0F 01     	ld  a, (FrontColor)
 46   0033 3C           	inc a
 47   0034 E6 0F        	and 0Fh
 48   0036 32 0F 01     	ld  (FrontColor), a
 49   0039 C3 00 00     	jp  TestLoop
 50   003C
 51   003C              ButDown:	; РЈРјРµРЅСЊС€РёС‚СЊ С†РІРµС‚ СЃРёРјРІРѕР»РѕРІ
 52   003C 3A 0F 01     	ld  a, (FrontColor)
 53   003F 3D           	dec a
 54   0040 E6 0F        	and 0Fh
 55   0042 32 0F 01     	ld  (FrontColor), a
 56   0045 C3 00 00     	jp  TestLoop
 57   0048
 58   0048              ButRight:	; РЈРІРµР»РёС‡РёС‚СЊ С†РІРµС‚ С„РѕРЅР°
 59   0048 3A 10 01     	ld  a, (BackColor)
 60   004B 3C           	inc a
 61   004C E6 0F        	and 0Fh
 62   004E 32 10 01     	ld  (BackColor), a
 63   0051 C3 00 00     	jp  TestLoop
 64   0054
 65   0054              ButLeft:	; РЈРјРµРЅСЊС€РёС‚СЊ С†РІРµС‚ С„РѕРЅР°
 66   0054 3A 10 01     	ld  a, (BackColor)
 67   0057 3D           	dec a
 68   0058 E6 0F        	and 0Fh
 69   005A 32 10 01     	ld  (BackColor), a
 70   005D C3 00 00     	jp  TestLoop
 71   0060
 72   0060              ChangeMode: ; РџРµСЂРµРєР»СЋС‡РёС‚СЊ СЂРµР¶РёРј
 73   0060 3A 11 01         ld  a, (Mode)
 74   0063 3C               inc a
 75   0064 FE 02            cp  2
 76   0066 C2 6A 00         jp  nz, SetMode
 77   0069 AF               xor a
 78   006A              SetMode:
 79   006A 32 11 01         ld  (Mode), a
 80   006D C3 00 00         jp  TestLoop
 81   0070
 82   0070              ;-----------------------------------------------------
 83   0070              ; Р—Р°РєСЂР°С€РёРІР°РµРЅРёРµ СЌРєСЂР°РЅР° РїРёРєСЃРµР»СЏРјРё РІ С€Р°С…РјР°С‚РЅРѕРј РїРѕСЂСЏРґРєРµ
 84   0070              ;-----------------------------------------------------
 85   0070
 86   0070              TestCheckerboard:
 87   0070 CD FA 00     	call Beep	; Р·РІСѓРєРѕРІРѕР№ СЃРёРіРЅР°Р»
 88   0073 CD EA 00         call SetColor
 89   0076 11 AA 55         ld   de, 55AAh
 90   0079 CD C4 00     	call ClearScreen
 91   007C C3 0B 00         jp   KeyLoop
 92   007F
 93   007F              ;-----------------------------------------------------
 94   007F              ; РўРµСЃС‚ СЃРєРѕСЂРѕСЃС‚Рё РІС‹РІРѕРґР° С‚РµРєСЃС‚Р°
 95   007F              ;-----------------------------------------------------
 96   007F
 97   007F              TestPrint:
 98   007F CD FA 00     	call Beep	; Р·РІСѓРєРѕРІРѕР№ СЃРёРіРЅР°Р»
 99   0082 CD EA 00         call SetColor
100   0085 11 00 00         ld   de, 0
101   0088 CD C4 00     	call ClearScreen
102   008B 0E 20        	ld   c, 20h		; РљРѕРґ РїРµСЂРІРѕРіРѕ СЃРёРјРІРѕР»Р°
103   008D
104   008D              TestPrintRep:
105   008D C5           	push bc
106   008E
107   008E 0E 0C        	ld   c, 0Ch		; РЈСЃС‚Р°РЅРѕРІРєР° РєСѓСЂСЃРѕСЂР° РІ РЅР°С‡Р°Р»Рѕ СЌРєСЂР°РЅР° РїСѓС‚РµРј РїРµС‡Р°С‚Рё СЃРёРјРІРѕР»Р° 0Ch (РєСЂРѕСЃСЃРїР»Р°С‚С„РѕСЂРјРµРЅРЅРѕ)
108   0090 CD 09 C8     	call bios_printChar
109   0093 C1           	pop  bc
110   0094 11 C0 05     	ld   de, 64*23	; РЎРєРѕР»СЊРєРѕ РІСЃРµРіРѕ СЃРёРјРІРѕР»РѕРІ РІС‹РІРѕРґРёС‚СЊ (23 СЃС‚СЂРѕРєРё СЂР°Р·СЂРµС€РµРЅРѕ РІ RAMFOS)
111   0097              PrintLoop:
112   0097 CD 09 C8     	call bios_printChar
113   009A 0C           	inc  c
114   009B
115   009B                  IF KOI8 == 1
116   009B C2 A3 00     	    jp   nz,  Print1    ; РџСЂС‹РіР°РµРј, РµСЃР»Рё РЅРµ РїРµСЂРµС€Р»Рё С‡РµСЂРµР· 0FFh
117   009E 0E 20        	    ld   c, 020h        ; РљРѕРґ РїРµСЂРІРѕРіРѕ СЃРёРјРІРѕР»Р° РљРћР7
118   00A0 C3 B3 00     	    jp   Print2
119   00A3              Print1:
120   00A3 79           	    ld   a, c
121   00A4 FE 80        	    cp   080h           ; РљРѕРґ РїРѕСЃР»РµРґРЅРµРіРѕ СЃРёРјРІРѕР»Р° РљРћР7 + 1
122   00A6 C2 B3 00     	    jp   nz, Print2
123   00A9 0E C0        	    ld   c, 0C0h        ; РљРѕРґ РїРµСЂРІРѕРіРѕ СЃРёРјРІРѕР»Р° РљРћР8
124   00AB                  ENDIF
125   00AB
126   00AB 79           	ld   a, c
127   00AC FE 80        	cp   080h               ; РљРѕРґ РїРѕСЃР»РµРґРЅРµРіРѕ СЃРёРјРІРѕР»Р° РљРћР7 + 1
128   00AE C2 B3 00     	jp   nz, Print2
129   00B1 0E 20        	ld   c, 020h            ; РљРѕРґ РїРµСЂРІРѕРіРѕ СЃРёРјРІРѕР»Р° РљРћР7
130   00B3
131   00B3              Print2:
132   00B3 1B           	dec  de
133   00B4 7A           	ld   a, d
134   00B5 B3           	or   e
135   00B6 C2 97 00     	jp   nz, PrintLoop
136   00B9
137   00B9 CD 12 C8     	call bios_keyCheck  ; РџСЂРѕРІРµСЂРєР° РЅР°Р¶Р°С‚РёСЏ Р»СЋР±РѕР№ РєР»Р°РІРёС€Рё
138   00BC FE FF        	cp   0FFh
139   00BE CA 8D 00         jp   z,TestPrintRep ; РќРµ РЅР°Р¶Р°С‚Р° - РїСЂРѕРґРѕР»Р¶Р°РµРј
140   00C1 C3 0B 00         jp   KeyLoop        ; РРЅР°С‡Рµ РІС‹С…РѕРґРёРј
141   00C4
142   00C4              ;-----------------------------------------------------
143   00C4              ; РћС‡РёСЃС‚РєР° СЌРєСЂР°РЅР°
144   00C4              ; de = СЃР»РѕРІРѕ РґР»СЏ Р·Р°РїРѕР»РЅРµРЅРёСЏ РїР°РјСЏС‚Рё
145   00C4              ; bc, hl - СЃРѕС…СЂР°РЅСЏСЋСЃС‚СЏ
146   00C4
147   00C4              ClearScreen:
148   00C4 E5               push hl
149   00C5 C5               push bc
150   00C6 21 00 00         ld   hl, 0  ; РЎРѕС…СЂР°РЅРµРЅРёРµ SP
151   00C9 39               add  hl, sp
152   00CA 22 0D 01         ld   (MemSP), hl
153   00CD 31 00 C0         ld   sp, 0C000h         ; РЈСЃС‚Р°РЅР°РІР»РёРІР°РµРј SP РІ РєРѕРЅРµС† РІРёРґРµРѕРїР°РјСЏС‚Рё
154   00D0 01 00 03         ld   bc, 300h           ; РџРѕРјРµС‰Р°РµРј РІ СЃС‚РµРє 3000h Р±Р°Р№С‚
155   00D3 EB               ex   hl, de
156   00D4              ClearLoop:
157   00D4 E5           	push hl
158   00D5 E5           	push hl
159   00D6 E5           	push hl
160   00D7 E5           	push hl
161   00D8 E5           	push hl
162   00D9 E5           	push hl
163   00DA E5           	push hl
164   00DB E5           	push hl
165   00DC 0B           	dec  bc
166   00DD 78           	ld   a, b
167   00DE B1           	or   c
168   00DF C2 D4 00     	jp   nz, ClearLoop
169   00E2 2A 0D 01     	ld   hl, (MemSP) ; Р’РѕСЃСЃС‚Р°РЅР°РІР»РёРІР°РµРј SP
170   00E5 F9           	ld   sp, hl
171   00E6 EB               ex   hl, de
172   00E7 C1           	pop  bc
173   00E8 E1           	pop  hl
174   00E9 C9           	ret
175   00EA
176   00EA              ;-----------------------------------------------------
177   00EA
178   00EA              SetColor:
179   00EA 3A 0F 01         ld   a, (FrontColor)
180   00ED 07               rlca
181   00EE 07               rlca
182   00EF 07               rlca
183   00F0 07               rlca
184   00F1 5F               ld   e, a
185   00F2 3A 10 01         ld   a, (BackColor)
186   00F5 B3               or   e
187   00F6 32 F8 FF         ld   (IO_COLOR), a
188   00F9 C9               ret
189   00FA
190   00FA              ;-----------------------------------------------------
191   00FA
192   00FA              Beep:	; Р—РІСѓРєРѕРІРѕР№ СЃРёРіРЅР°Р»
193   00FA 01 5F 0F     	ld  bc, 0F5Fh
194   00FD 3E 0A        	ld  a, 0Ah	; РєРѕРјР°РЅРґР° РґР»СЏ Р’Р’55 - СѓСЃС‚Р°РЅРѕРІРёС‚СЊ PC5 РІ 0
195   00FF              Snd1:	; С†РёРєР» Р·РІСѓРєРѕРІРѕРіРѕ СЃРёРіРЅР°Р»Р°
196   00FF 32 E3 FF     	ld  (IO_KEYB_MODE), a   ; Р·Р°РїРёСЃСЊ РєРѕРјР°РЅРґС‹ РІ СЂРµРіРёСЃС‚СЂ СѓРїСЂР°РІР»РµРЅРёСЏ РїРѕСЂС‚Р° РєР»Р°РІРёР°С‚СѓСЂС‹ Р’Р’55
197   0102              Snd2:
198   0102 05           	dec b                   ; Р·Р°РґРµСЂР¶РєР° РЅР° FFh С†РёРєР»РѕРІ (РІ b)
199   0103 C2 02 01     	jp  nz, Snd2
200   0106 EE 01        	xor 01h                 ; РєРѕРјР°РЅРґР° РґР»СЏ Р’Р’55 - СѓСЃС‚Р°РЅРѕРІРёС‚СЊ PC5 РІ РёРЅРІРµСЂСЃРЅРѕРµ Р·РЅР°С‡РµРЅРёРµ
201   0108 0D           	dec c
202   0109 C2 FF 00     	jp  nz, Snd1            ; РїРѕРІС‚РѕСЂРёС‚СЊ FFh СЂР°Р· (РІ C)
203   010C C9           	ret
204   010D
205   010D              ;-----------------------------------------------------
206   010D
207   010D 00 00        MemSP:          DW     0000h
208   010F 0F           FrontColor:     DB     0Fh
209   0110 00           BackColor:      DB     00h
210   0111 00           Mode:           DB     00h
211   0112
212   0112              ;-----------------------------------------------------
213   0112
214   0112                  END
